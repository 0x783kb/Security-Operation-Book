# T1587-002-开发能力-代码签名证书

## 描述

在入侵目标之前，攻击者可能会开发自签名的代码签名证书，用于目标定位期间。代码签名是对可执行文件和脚本进行数字签名的过程，以确认软件作者并确保代码未被更改或破坏。代码签名可为开发者的程序提供一定的真实性，并保证程序未被篡改。相比未签名的代码，即使用户或安全工具不知道颁发证书的人或代码的作者是谁，签名的代码也可能更容易获得信任。

攻击者可能通过开发自签名的代码签名证书来伪装合法软件，从而绕过安全检测或提升恶意代码的可信度。自签名证书通常由攻击者自行生成，不依赖受信任的证书颁发机构（CA），因此成本低廉且易于实现。尽管自签名证书可能触发安全警告，但在某些情况下，攻击者可通过社会工程学或其他技术诱导用户忽略这些警告。

## 测试案例

暂无，仅提供辅助理解案例：

1. **恶意软件团伙盗取大量证书绕过代码签名检查**  
   攻击者通过窃取合法的代码签名证书，伪装恶意软件以绕过安全软件的检测机制。例如，某些恶意软件使用从合法软件公司泄露的证书进行签名，使其看似可信。  
   参考链接：<https://www.anquanke.com/post/id/83654>

2. **恶意病毒伪造微软等签名绕过安全软件检测后疯狂挖矿**  
   攻击者伪造知名公司的代码签名证书（如伪装成微软的签名），使恶意挖矿程序被误认为是合法软件，从而规避安全检测并在受害者系统上执行加密货币挖矿。  
   参考链接：<https://www.landiannews.com/archives/47396.html>

## 检测日志

**无法有效监测**  
由于自签名证书的创建通常发生在攻击者的环境中，且不直接与目标系统交互，因此难以通过日志直接检测此类活动。检测可能需要依赖后续行为（如签名代码的执行或异常证书的使用）。以下是可能相关的日志来源：

- **系统日志**：Windows 事件日志（如事件 ID 4657）可能记录证书安装或信任更改事件。
- **安全软件日志**：防病毒或 EDR 工具可能记录可疑签名或不受信任证书的执行尝试。
- **网络日志**：与证书相关的网络请求（如 CRL 或 OCSP 检查）可能提供间接线索。

## 测试复现

以下是一个概念性复现思路，仅供参考：

1. **生成自签名证书**：
   - 使用工具（如 OpenSSL 或 Windows 的 `makecert`）生成自签名证书。
   - 示例命令（OpenSSL）：
     ```bash
     openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes
     ```
   - 将生成的证书用于签署简单的测试程序（如 PowerShell 脚本或可执行文件）。

2. **测试签名程序**：
   - 在目标系统上运行签名后的程序，观察安全软件（如 Windows Defender）的反应。
   - 模拟用户忽略证书不受信任警告的行为，验证是否能绕过某些安全检查。

**注意**：此复现仅用于学习和测试目的，切勿用于非法活动。

## 测试留痕

无明显留痕。  
自签名证书的开发活动通常不会在目标系统上留下直接痕迹。相关留痕可能出现在后续阶段，包括：

- **证书安装**：如果攻击者将自签名证书安装到目标系统的信任存储中，可能在证书管理器或系统日志中留下记录。
- **恶意软件执行**：签名后的恶意代码可能触发防病毒软件的警告或异常行为日志。
- **网络活动**：与证书验证相关的网络请求（如 CRL 检查）可能被记录在网络流量日志中。

## 检测规则/思路

**检测规则**  
无明确的检测规则。由于此类活动主要发生在攻击者的环境中，传统日志分析或入侵检测系统难以直接捕获。以下是一些可能的检测思路：

1. **监控异常证书行为**  
   - 检查系统中安装的代码签名证书，识别来源不明或自签名的证书。  
   - 使用工具（如 Windows CertMgr 或 OpenSSL）分析证书链，检测非受信任根证书颁发的签名。  

2. **行为分析**  
   - 监控可执行文件的签名状态，重点关注签名无效或使用自签名证书的文件。  
   - 使用 EDR（端点检测与响应）工具检测异常进程或文件的执行行为，尤其是与签名不匹配的情况。  

3. **网络流量分析**  
   - 检测与已知恶意或可疑证书相关的网络通信（如证书吊销列表 CRL 请求）。  
   - 监控异常的 HTTPS 流量，检查是否涉及自签名证书的 TLS 连接。  

4. **SIEM 集成**  
   - 将证书相关的事件（如证书安装、签名验证失败）集成到 SIEM 系统中，设置告警规则以发现异常模式。

## 建议

### 缓解措施

由于代码签名证书的开发发生在企业防御和控制范围之外，难以通过预防性措施直接缓解。以下是一些建议：

1. **增强代码签名验证**  
   - 确保系统只信任来自受信证书颁发机构（CA）的签名代码，限制自签名证书的执行。  
   - 在操作系统或安全软件中配置策略，阻止未签名或签名无效的可执行文件运行。  
   - 示例 Windows 组策略设置：
     - 路径：`计算机配置 -> 管理模板 -> 系统 -> 驱动程序安装`
     - 启用“代码签名用于设备驱动程序”并选择“阻止”。

2. **用户教育**  
   - 培训用户识别可疑软件，避免运行未知来源或提示证书不受信任的程序。  
   - 教授用户如何检查软件的数字签名（如右键单击文件 -> 属性 -> 数字签名）。

3. **应用程序白名单**  
   - 部署应用程序白名单策略，仅允许经过验证的合法应用程序运行，减少恶意签名的影响。  
   - 示例工具：Windows AppLocker 或第三方解决方案（如 Carbon Black）。

4. **证书管理**  
   - 定期审计系统中的证书，移除或限制不受信任的根证书或中间证书。  
   - 使用证书透明度（CT）日志监控可疑证书的颁发。  

5. **系统加固**  
   - 禁用用户安装不受信任证书的能力，限制对证书存储的修改权限。  
   - 配置防火墙规则，限制与未知证书相关的网络通信。

### 检测

由于此类活动通常在目标组织的可见性之外，检测工作应集中在相关后续行为上，包括但不限于：  
- **异常签名检测**：监控系统中运行的可执行文件，检查签名证书的合法性（如是否来自未知或自签名证书）。  
- **根证书安装监控**：检测系统中是否安装了非预期或不受信任的根证书，可能是攻击者为后续活动铺垫的迹象。  
  - 示例 Windows 事件 ID：4657（注册表更改，可能涉及证书存储）。  
- **行为监控**：通过 EDR 或 SIEM 系统，关注异常的文件执行、进程行为或网络活动，尤其是与自签名证书相关的行为。  
- **威胁情报整合**：使用威胁情报平台（如 VirusTotal 或 Recorded Future）检查已知恶意证书的指纹或哈希值。

## 参考推荐

- MITRE ATT&CK: T1587-002  
  <https://attack.mitre.org/techniques/T1587/002/>  

- 恶意软件团伙盗取大量证书用来绕过代码签名检查  
  <https://www.anquanke.com/post/id/83654>  

- 恶意病毒伪造微软等签名绕过安全软件检测后疯狂挖矿  
  <https://www.landiannews.com/archives/47396.html>