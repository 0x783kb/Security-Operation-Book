# T1596-002-搜索开放的技术数据库-WHOIS

## 描述
攻击者在入侵目标组织之前，可能通过搜索公开的WHOIS数据库收集目标的网络信息。WHOIS数据库由区域互联网注册中心（RIR）维护，存储有关注册域名的详细信息，例如域名所有人、联系信息（姓名、邮箱、电话）、注册商、注册和到期日期、分配的IP块以及DNS名称服务器。这些信息可帮助攻击者了解目标的网络架构、关键联系人或潜在攻击入口。

攻击者可能通过以下方式收集WHOIS信息：
- **公开查询**：使用在线WHOIS查询工具或命令行工具（如`whois`）获取域名注册信息。
- **社会工程**：通过钓鱼或伪装身份诱导员工泄露WHOIS管理凭据。
- **被动分析**：结合其他公开数据（如DNS记录、泄露文档）验证WHOIS信息。
- **自动化搜刮**：使用脚本或工具批量查询WHOIS数据，提取目标的关联域名或IP。

收集到的WHOIS信息可能为后续攻击活动做准备，例如主动扫描（T1595）、搜索开放网站/域（T1593）、建立运营资源（T1583/T1584）或通过钓鱼（T1566）或信任关系（T1199）实现初始访问。

## 测试案例
以下是模拟攻击者收集WHOIS信息的常见方法和工具：
- **在线WHOIS查询**：
  - **站长之家** (<https://whois.chinaz.com>): 查询域名注册信息、注册商及到期时间。
  - **爱站网** (<https://whois.aizhan.com>): 提供域名注册详情和历史记录。
  - **IP138** (<https://www.ip138.com>): 查询域名和关联IP信息。
  - **腾讯云域名信息查询** (<https://cloud.tencent.com>): 获取域名注册和NS记录。
  - **ICANN Lookup** (<https://lookup.icann.org>): 官方WHOIS查询工具。
  - **新网WHOIS** (<https://www.xinnet.com>): 查询国内域名注册信息。
  - **微步在线** (<https://x.threatbook.cn>): 提供WHOIS信息和威胁情报分析。
  - **Bugscaner** (<https://whois.bugscaner.com>): 提供WHOIS和DNS查询功能。
- **命令行工具**：
  - **whois**: 在Linux/Unix系统中运行`whois target.com`查询域名信息。
  - **Nmap WHOIS脚本**: 使用`nmap --script=whois-domain target.com`查询WHOIS信息并扫描目标端口。
  - **dnsenum**: 结合WHOIS查询和DNS枚举，获取域名相关信息。
- **社会工程**：
  - 伪装成域名注册商发送钓鱼邮件，诱导员工泄露WHOIS管理平台凭据。
  - 在社交媒体或论坛（如LinkedIn、QQ群）收集员工泄露的域名信息。
- **案例场景**：
  - 攻击者通过ICANN Lookup查询目标域名的注册邮箱，发现其用于其他服务，发起针对性钓鱼攻击。
  - 使用`whois`命令结合Nmap扫描，发现目标的NS服务器存在未打补丁的漏洞，进而发起攻击。
  - 参考案例：<https://blog.csdn.net/m0_48520508/article/details/107301211>，通过WHOIS信息收集目标的联系人邮箱并结合社会工程实现初始访问。

## 检测日志
WHOIS信息收集多通过公开数据库或外部查询进行，难以直接监测。以下是可能的日志来源：
- **DNS服务器日志**：
  - 记录异常的DNS查询，可能与WHOIS数据验证相关。
- **Web服务器日志**：
  - 检测与WHOIS管理平台相关的异常登录尝试或HTTP请求。
- **邮件服务器日志**：
  - 监控钓鱼邮件或社会工程攻击，可能与WHOIS信息收集相关。
- **网络流量日志**：
  - 检测外部主机对组织DNS服务器或管理平台的异常查询。

## 测试复现
暂无标准化复现流程。可通过以下方式模拟：
- **被动收集**：
  - 使用ICANN Lookup或站长之家查询目标域名的WHOIS记录，记录注册人信息和NS服务器。
  - 结合SecurityTrails验证WHOIS数据中的IP块或子域名。
- **主动查询**：
  - 在授权测试环境中，使用`whois target.com`或`nmap --script=whois-domain target.com`查询WHOIS信息。
- **社会工程模拟**：
  - 在红队测试中，伪装成注册商发送钓鱼邮件，诱导员工泄露WHOIS管理凭据。
- **综合测试**：
  - 结合FOFA或Shodan搜索与WHOIS数据关联的资产，验证暴露的服务器或服务。

## 测试留痕
- **被动WHOIS查询**：通过公开数据库查询，通常不留明显痕迹。
- **主动查询**：可能在DNS服务器或防火墙日志中记录异常查询或扫描流量。
- **社会工程**：可能在邮件服务器或员工设备上留下钓鱼交互记录。
- **WHOIS管理平台**：异常登录尝试可能在管理平台日志中记录。

## 检测规则/思路
由于WHOIS信息收集多发生在目标组织视野之外，检测需结合多种手段：
- **DNS查询监控**：
  - 配置DNS服务器记录查询日志，检测异常的WHOIS或NS查询模式。
  - 使用DNS防火墙（如Cloudflare Gateway）阻止已知的恶意查询来源。
- **网络流量分析**：
  - 部署IDS/IPS（如Snort、Suricata）监控异常DNS查询或针对管理端口的扫描。
  - 使用Zeek或NetFlow分析WHOIS相关请求模式，识别潜在的枚举行为。
- **信息泄露防护**：
  - 使用DLP（数据丢失防护）工具，检测员工通过邮件或社交媒体泄露WHOIS相关信息。
  - 监控公开信息源（如Pastebin、暗网论坛）中是否出现组织的WHOIS数据。
- **威胁情报整合**：
  - 结合威胁情报平台（如微步在线、奇安信），识别已知的WHOIS查询工具或恶意IP。
  - 定期检查WHOIS数据库中的记录，评估信息暴露风险。

## 建议
- **减少信息暴露**：
  - 使用WHOIS隐私保护服务，隐藏注册人联系方式和公司信息。
  - 定期审查WHOIS记录，移除不必要的敏感信息（如个人邮箱）。
  - 对员工进行安全意识培训，防止通过社会工程泄露WHOIS管理凭据。
- **域名安全加固**：
  - 启用域名注册锁，防止未经授权的域名转移。
  - 实施MFA（多因素认证）保护WHOIS管理平台。
  - 定期更新NS记录，移除过期的服务器信息。
- **主动监控与响应**：
  - 使用微步在线或ICANN Lookup定期自查组织的WHOIS暴露情况，修复问题。
  - 部署DNS日志分析工具（如Splunk、ELK），监控异常查询行为。
  - 使用威胁狩猎（Threat Hunting）技术，主动搜索可能的WHOIS侦察活动。
- **后续阶段检测**：
  - 重点监控攻击者生命周期的后续阶段（如初始访问T1566、信任关系T1199），通过异常流量或钓鱼行为间接发现WHOIS侦察活动。

## 参考资料
- MITRE ATT&CK: T1596-002  
  <https://attack.mitre.org/techniques/T1596/002/>
- Whois信息收集及利用方式  
  <https://blog.csdn.net/m0_48520508/article/details/107301211>
- WHOIS查询与安全  
  <https://www.kancloud.cn/noahs/src_hacker/2120641>