# T1564.001-Win-发现攻击者在回收站中隐藏恶意软件

## 描述

攻击者可能会将文件和目录设置为隐藏，以逃避检测机制。为了防止普通用户意外更改系统上的特殊文件，大多数操作系统都具有“隐藏”文件的功能。当用户使用GUI浏览文件系统或在命令行上使用常规命令时，这些文件不会显示。用户必须通过一系列图形用户界面（GUI）提示或使用命令行开关（对于Windows为`dir /a`，对于Linux和macOS为`ls –a`）明确要求显示隐藏文件。

在Linux和macOS上，用户只需将“.”作为文件或文件夹名称的第一个字符即可将其标记为隐藏。默认情况下，以“.”开头的文件和文件夹在Finder应用程序和标准命令行实用程序（如`ls`）中是隐藏的。用户必须专门更改设置才能查看这些文件。

macOS上的文件也可以用`UF_HIDDEN`标志标记，这可以防止在Finder.app中看到它们，但仍然允许在Terminal.app中看到它们。在Windows上，攻击者可以使用`attrib.exe`二进制文件将特定文件标记为隐藏。许多应用程序都会创建这些隐藏的文件和文件夹来存储信息，以免使用户的工作空间变得混乱。例如，SSH实用程序会创建一个`.ssh`文件夹，该文件夹处于隐藏状态，其中包含用户的已知主机和密钥。

攻击者可以利用此优势来隐藏系统上任何位置的文件和文件夹，并逃避不包含对隐藏文件的调查的典型用户或系统分析。

## 测试案例

攻击者调用隐藏在回收站中的恶意程序。`$recycle.bin`文件夹是系统重要的隐藏文件，一般存在于磁盘根目录下。它是系统“回收站”在每一个磁盘上的链接文件夹，用于保存磁盘上删除的文件或者文件夹信息，当我们恢复误删除到回收站中的文件或者文件夹时大有用处。通常我们设置显示磁盘的隐藏文件后，才能看到它。

Win Vista以前的Windows系统，该文件夹名称为:`Recycle`; Win Vista(Win7/8)以后系统一般名称为`$RECYCLE.BIN`。

## 检测日志

* Windows 安全日志
* Windows Sysmon日志（推荐用于更详细的进程和文件活动监控）

## 测试复现

攻击者可能通过直接路径调用位于回收站内的可执行文件，如下所示：

```bash
C:\Windows\system32>C:\$Recycle.bin\$R54R99P.exe
nbtscan 1.0.35 - 2008-04-08 - http://www.unixwiz.net/tools/

usage: C:\$Recycle.bin\$R54R99P.exe [options] target [targets...]

   Targets are lists of IP addresses, DNS names, or address
   ranges. Ranges can be in /nbits notation ("192.168.12.0/24")
   or with a range in the last octet ("192.168.12.64-97")

   -V        show Version information
   -f        show Full NBT resource record responses (recommended)
   -H        generate HTTP headers
   -v        turn on more Verbose debugging
   -n        No looking up inverse names of IP addresses responding
   -p <n>    bind to UDP Port <n> (default=0)
   -m        include MAC address in response (implied by '-f')
   -T <n>    Timeout the no-responses in <n> seconds (default=2 secs)
   -w <n>    Wait <n> msecs after each write (default=10 ms)
   -t <n>    Try each address <n> tries (default=1)
   -1        Use Winsock 1 only
   -P        generate results in perl hashref format
```

在上述示例中，`nbtscan.exe`是一个合法的网络扫描工具，但在这里被模拟为攻击者隐藏在回收站中的恶意程序。攻击者可以替换为任何其他恶意可执行文件。

## 测试留痕

### Windows 安全日志

当恶意程序在回收站中被执行时，Windows安全日志中会生成**事件ID 4688（进程创建）**。此事件将记录新创建进程的详细信息，包括其完整路径和启动它的父进程。

```log
日志名称:          Security
来源:            Microsoft-Windows-Security-Auditing
日期:            2021/4/6 17:39:04
事件 ID:         4688
任务类别:          进程创建
级别:            信息
关键字:           审核成功
用户:            暂缺
计算机:           12306BR0B4DD.361a.com
描述:
已创建新进程。

创建者主题:
 安全 ID:  361A\12306br0
 帐户名:  12306br0
 帐户域:  361A
 登录 ID:  0x507C3

目标主题:
 安全 ID:  NULL SID
 帐户名:  -
 帐户域:  -
 登录 ID:  0x0

进程信息:
 新进程 ID:  0x1224
 新进程名称: C:\$Recycle.Bin\$R54R99P.exe
 令牌提升类型: %%1937
 强制性标签:  Mandatory Label\High Mandatory Level
 创建者进程 ID: 0x15d8
 创建者进程名称: C:\Windows\System32\cmd.exe
 进程命令行: C:\$Recycle.bin\$R54R99P.exe
```

**关键信息提取：**

* **新进程名称(New Process Name):**指向了回收站中的可执行文件路径，如`C:\$Recycle.Bin\$R54R99P.exe`。
* **创建者进程名称(Creator Process Name):**显示了启动该恶意进程的父进程，在此示例中是`C:\Windows\System32\cmd.exe`。攻击者可能通过`cmd.exe`、`powershell.exe`、计划任务等方式启动。
* **进程命令行(Process Command Line):**记录了完整的执行命令行，这对于分析攻击行为至关重要。

## 检测规则/思路

为了检测攻击者在回收站中隐藏和执行恶意软件，我们可以监控进程创建事件，特别是那些源自回收站路径的可执行文件。

```yml
title: 发现攻击者在回收站中隐藏恶意软件
description: 检测攻击者执行隐藏在回收站中的恶意程序
status: experimental
references:
    - https://github.com/microsoft/Microsoft-365-Defender-Hunting-Queries/blob/master/Execution/Malware_In_recyclebin.txt
logsource:
    product: windows
    service: security # 也可以配置为 sysmon，提供更丰富的数据
detection:
    selection:
        EventID: 4688 # Windows 安全日志，进程创建事件ID
        ParentProcessName|endswith: # 常见的可能启动恶意进程的父进程
            - 'cmd.exe'
            - 'ftp.exe' # 不常见但有可能用于下载和执行
            - 'schtasks.exe' # 通过计划任务执行
            - 'powershell.exe'
            - 'rundll32.exe' # 可能用于DLL劫持或执行
            - 'regsvr32.exe' # 可能用于无文件攻击或执行
            - 'msiexec.exe' # 可能用于执行MSI包中的恶意代码
        CommandLine|contains: '*Recycle.bin\*' # 命令行包含回收站路径
    condition: selection
level: high
```

### 建议

基于Windows安全日志（高版本操作系统，需开启命令行审计）或**Sysmon日志**（推荐，提供更详细的进程、文件、网络活动信息）可进行有效检测。

* **Sysmon配置：确保Sysmon已正确配置并收集事件ID 1（进程创建）和事件ID 11（文件创建）**。Sysmon的进程创建事件通常包含更详细的进程路径、命令行、哈希值等信息，对于识别可疑活动更为有效。
* \*\*路径监控：\*\*重点关注任何从`$Recycle.bin`路径下启动的进程。正常情况下，用户或系统进程不应直接从回收站执行程序。
* \*\*父进程分析：\*\*结合父进程信息，例如如果一个不常见的父进程（如某些服务或应用程序）启动了回收站中的可执行文件，则需要高度关注。
* \*\*行为链分析：\*\*将回收站内的执行与其他攻击阶段（如文件写入、网络连接）关联起来，以发现完整的攻击链。


## 参考推荐

- MITRE-ATT\&CK: T1564.001  
  https://attack.mitre.org/techniques/T1564/001/
- windows10系统$recycle.bin的详细删除方法介绍  
  https://www.pconline.com.cn/win10/1102/11023668.html
