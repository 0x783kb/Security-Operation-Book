# T1596-003-搜索开放的技术数据库-数字签名

## 描述
攻击者在入侵目标组织之前，可能通过搜索公开的数字证书数据收集目标的网络信息。数字证书由证书颁发机构（CA）签发，用于验证签名内容的来源（如HTTPS SSL/TLS通信）。这些证书通常包含有关注册组织的信息，例如域名、子域名、组织名称、位置和邮箱地址。攻击者可利用这些信息识别目标的网络资产、关键联系人或潜在攻击入口。

攻击者可能通过以下方式收集数字证书信息：
- **公开证书透明度（CT）日志**：查询证书透明度数据库（如crt.sh、Censys）以获取目标的SSL/TLS证书详情。
- **被动分析**：从加密网络流量中提取证书信息（如服务器Banner或TLS握手数据）。
- **社会工程**：通过钓鱼或伪装身份诱导员工泄露与证书管理相关的信息。
- **搜索引擎和公开信息**：利用Google或其他平台搜索与目标相关的证书或泄露文档。

收集到的数字证书信息可能为后续攻击活动做准备，例如主动扫描（T1595）、搜索开放网站/域（T1593）、建立运营资源（T1583/T1584）或通过外部远程服务（T1133）或钓鱼攻击（T1566）实现初始访问。

## 测试案例
以下是模拟攻击者收集数字证书信息的常见方法和工具：
- **证书透明度（CT）日志查询**：
  - **crt.sh** (<https://crt.sh>): 查询目标域名的SSL/TLS证书，获取域名、子域名和邮箱地址。例如，搜索`%.target.com`列出所有相关证书。
  - **Censys** (<https://censys.io>): 分析目标的SSL证书，提取组织信息和关联IP。
  - **Facebook CT Search** (<https://developers.facebook.com/tools/ct>): 提供证书透明度日志查询，识别目标的子域名。
  - **Google Transparency Report** (<https://transparencyreport.google.com/https/certificates>): 查看目标域名的证书历史记录。
- **被动证书提取**：
  - 使用Wireshark捕获目标网站的TLS握手数据，提取SSL/TLS证书中的域名和组织信息。
  - 利用Burp Suite分析HTTPS流量，获取证书详情。
- **其他工具**：
  - **SSLShopper** (<https://www.sslshopper.com/ssl-checker.html>): 检查目标域名的证书状态和配置。
  - **SSL Labs** (<https://www.ssllabs.com/ssltest>): 分析目标的SSL/TLS配置，提取证书信息。
- **社会工程**：
  - 伪装成CA或IT管理员发送钓鱼邮件，诱导员工泄露证书管理平台的凭据。
  - 在社交媒体或论坛（如LinkedIn、QQ群）收集员工泄露的证书相关信息。
- **案例场景**：
  - 攻击者通过crt.sh查询目标的子域名，发现未正确配置的测试环境（如test.target.com），并利用其漏洞发起攻击。
  - 使用Censys提取目标的SSL证书，获取注册邮箱并发起针对性钓鱼攻击。
  - 参考案例：<https://www.freebuf.com/articles/database/195169.html>，通过CT日志发现敏感子域名，结合漏洞利用实现初始访问。

## 检测日志
数字证书信息收集多通过公开数据库或外部查询进行，难以直接监测。以下是可能的日志来源：
- **Web服务器日志**：
  - 检测异常的HTTPS请求或证书检查，可能与证书提取相关。
- **网络流量日志**：
  - 监控异常的TLS握手流量，识别潜在的证书提取行为。
- **DNS日志**：
  - 检测针对组织域名的异常查询，可能与CT日志搜索相关。
- **证书管理平台日志**：
  - 记录异常的登录尝试或证书配置更改。

## 测试复现
暂无标准化复现流程。可通过以下方式模拟：
- **被动收集**：
  - 使用crt.sh或Censys查询目标域名的SSL/TLS证书，记录子域名和组织信息。
  - 通过Wireshark捕获目标网站的TLS握手数据，提取证书详情。
- **主动探测**：
  - 在授权测试环境中，使用SSL Labs分析目标的SSL/TLS配置，检查证书暴露的信息。
  - 测试证书透明度日志，验证是否存在敏感子域名。
- **社会工程模拟**：
  - 在红队测试中，伪装成CA发送钓鱼邮件，诱导员工泄露证书管理凭据。

## 测试留痕
- **被动查询**：通过CT日志或公开数据库查询，通常不留明显痕迹。
- **主动探测**：可能在Web服务器或网络流量日志中记录异常的TLS请求或扫描行为。
- **社会工程**：可能在邮件服务器或员工设备上留下钓鱼交互记录。
- **证书管理平台**：异常登录尝试可能在管理平台日志中记录。

## 检测规则/思路
由于数字证书信息收集多发生在目标组织监测范围之外，检测需结合多种手段：
- **网络流量监控**：
  - 使用IDS/IPS（如Snort、Suricata）检测异常的TLS握手或证书提取行为。
  - 部署WAF（Web应用防火墙）监控异常的HTTPS请求，识别证书探测。
- **DNS查询监控**：
  - 记录针对组织域名的异常DNS查询，可能与CT日志搜索相关。
  - 使用DNS防火墙（如Cloudflare Gateway）阻止已知的恶意查询来源。
- **信息泄露防护**：
  - 使用DLP（数据丢失防护）工具，检测员工通过邮件或社交媒体泄露证书相关信息。
  - 监控公开信息源（如Pastebin、暗网论坛）中是否出现组织的证书数据。
- **威胁情报整合**：
  - 结合威胁情报平台（如微步在线、奇安信），识别已知的CT日志查询工具或恶意IP。
  - 定期检查CT日志（如crt.sh），评估暴露的子域名或邮箱风险。

## 建议
- **减少信息暴露**：
  - 使用子域名最小化策略，避免在证书中暴露敏感子域名。
  - 配置SSL/TLS证书时，限制公开的组织信息（如邮箱、地址）。
  - 定期检查CT日志（如crt.sh），识别并移除不必要的子域名记录。
- **证书安全加固**：
  - 使用强加密算法和最新TLS协议（如TLS 1.3）保护证书。
  - 实施MFA（多因素认证）保护证书管理平台。
  - 定期更新和续期证书，防止过期或泄露。
- **主动监控与响应**：
  - 使用Censys或SSL Labs定期自查组织的证书暴露情况，修复配置问题。
  - 部署网络流量分析工具（如Zeek、NetFlow）监控异常TLS流量。
  - 使用威胁狩猎（Threat Hunting）技术，主动搜索可能的证书侦察活动。
- **后续阶段检测**：
  - 重点监控攻击者生命周期的后续阶段（如初始访问T1133、钓鱼T1566），通过异常流量或登录行为间接发现侦察活动。

## 参考资料
- MITRE ATT&CK: T1596-003  
  <https://attack.mitre.org/techniques/T1596/003/>
- 全流程信息收集方法总结  
  <https://www.freebuf.com/articles/database/195169.html>
- 渗透测试之信息收集（二）  
  <https://zhuanlan.zhihu.com/p/86250911>