# T1588-004-获取能力-数字证书

## 描述

在入侵目标组织之前，攻击者可能会购买或窃取可在目标定位期间使用的SSL/TLS证书。SSL/TLS证书旨在确保通信安全与信任，包含密钥信息、所有者身份信息以及由可信实体验证的数字签名。如果签名有效且检查证书的人员信任签名者，则可确认使用该密钥与其所有者进行安全通信。

攻击者可能通过购买或窃取SSL/TLS证书用于恶意目的，例如加密命令与控制（C2）流量（如通过Web协议）、伪装合法服务，或在证书被添加到目标系统的信任根存储（即安装根证书）后实施中间人（MITM）攻击。攻击者可以使用傀儡组织或利用从先前被入侵实体窃取的信息冒充合法实体，通过证书颁发机构（CA）完成证书购买。此外，攻击者可能直接从被入侵的第三方窃取SSL/TLS证书，或从暗网市场购买泄露的证书。某些证书颁发机构（如提供免费域名验证证书的机构）可能被攻击者利用，免费获取SSL/TLS证书。攻击者还可能注册或劫持域名，以便后续购买或使用SSL/TLS证书。

## 测试案例

暂无，仅提供辅助理解案例：

1. **购买免费SSL/TLS证书**  
   攻击者通过免费证书颁发机构（如Let's Encrypt）为恶意域名获取SSL/TLS证书，用于配置伪装的HTTPS网站或C2服务器，诱导用户信任或隐藏恶意流量。

2. **窃取企业证书**  
   攻击者入侵合法企业的服务器，窃取SSL/TLS证书及其私钥，用于伪装成受信任的网站或服务，执行MITM攻击或分发恶意内容。

## 检测日志

**无法有效监测**  
SSL/TLS证书的获取通常发生在攻击者的环境中，与目标系统无直接交互，因此难以通过日志直接检测。可能相关的日志来源包括：

- **系统日志**：Windows事件日志（如事件ID 4657）可能记录证书安装或信任更改事件。
- **网络日志**：与证书验证相关的网络请求（如OCSP或CRL检查）可能提供间接线索。
- **安全软件日志**：EDR或防病毒工具可能记录与不受信任或伪造证书相关的异常网络连接或进程行为。

## 测试复现

无具体复现方法。  

## 测试留痕

无明显留痕。  
SSL/TLS证书的获取活动通常不会在目标系统上留下直接痕迹。相关留痕可能出现在后续阶段，包括：

- **证书安装**：如果攻击者将伪造或窃取的证书安装到目标系统的信任根存储中，可能在证书管理器或系统日志中留下记录。
- **网络活动**：与伪造证书相关的HTTPS流量可能触发安全警告或被记录在网络日志中（如TLS握手失败）。
- **恶意行为**：使用伪造证书的恶意服务或C2通信可能在EDR或防病毒日志中留下异常行为记录。

## 检测规则/思路

**检测规则**  
无明确的检测规则。由于证书的获取主要发生在攻击者的环境中，传统日志分析或入侵检测系统难以直接捕获。以下是一些可能的检测思路：

1. **监控异常证书行为**  
   - 检查系统中安装的SSL/TLS证书，识别来源不明或可疑的证书。  
   - 使用工具（如Windows CertMgr或OpenSSL）分析证书链，检测非受信任根证书或异常颁发者。  

2. **网络流量分析**  
   - 监控HTTPS流量，检测使用伪造或不受信任证书的异常TLS连接。  
   - 检查与证书验证相关的网络请求（如CRL或OCSP请求），识别可疑证书指纹。  

3. **行为分析**  
   - 使用EDR工具检测与伪造证书相关的异常进程或网络行为，如PowerShell脚本发起的HTTPS请求。  

4. **威胁情报整合**  
   - 使用威胁情报平台（如VirusTotal、ThreatConnect）检查已知被盗或伪造证书的指纹或域名，关联潜在的攻击者基础设施。

## 建议

### 缓解措施

由于SSL/TLS证书的获取发生在企业防御和控制范围之外，难以通过预防性措施直接缓解。以下是一些建议：

1. **增强证书验证**  
   - 配置系统仅信任来自受信证书颁发机构（CA）的SSL/TLS证书，限制伪造或不受信任证书的使用。  
   - 在浏览器或操作系统中启用严格的证书检查，阻止不受信任证书的连接。  
   - 示例Windows组策略设置：
     - 路径：`计算机配置->管理模板->系统->Internet通信管理->Internet通信设置`
     - 启用“关闭自动根证书更新”以防止意外信任。

2. **用户教育**  
   - 培训用户识别可疑HTTPS网站，尤其是提示证书不受信任的页面。  
   - 教授用户检查证书详情（如右键单击浏览器锁图标->查看证书）。

3. **网络安全控制**  
   - 部署TLS解密设备（如下一代防火墙）以检查加密流量，识别伪造或不受信任证书的使用。  
   - 配置入侵检测系统（IDS）以检测异常TLS握手或证书错误。

4. **证书管理**  
   - 定期审计系统中的根证书和中间证书，移除或限制不受信任的证书。  
   - 使用证书透明度（CT）日志监控可疑证书的颁发。  

5. **域名保护**  
   - 监控与组织相关的域名注册，防止攻击者注册相似域名用于伪造证书。  
   - 使用域名监控服务（如DomainTools）检测可疑域名活动。

### 检测

由于此类活动通常在目标组织的可见性之外，检测工作应集中在相关后续行为上，包括但不限于：  
- **异常证书检测**：监控系统中运行的HTTPS连接，检查证书是否为伪造或来自不受信任的CA。  
- **根证书安装监控**：检测系统中是否安装了非预期或不受信任的根证书，可能是攻击者铺垫MITM攻击的迹象。  
  - 示例Windows事件ID：4657（注册表更改，可能涉及证书存储）。  
- **网络行为监控**：通过EDR或SIEM系统，关注异常的HTTPS流量、脚本执行或与可疑域名相关的通信。  
- **证书信息追踪**：利用证书透明度（CT）日志或其他服务，跟踪Internet上使用的证书，识别与攻击者基础设施相关的证书。

## 参考推荐

- MITRE ATT&CK: T1588-004  
  <https://attack.mitre.org/techniques/T1588/004/>