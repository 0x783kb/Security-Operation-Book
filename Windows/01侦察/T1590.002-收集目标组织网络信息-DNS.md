# T1590-002-收集目标组织网络信息-DNS

## 来自ATT&CK的描述

攻击者在入侵目标组织之前，可能收集其DNS相关信息，以了解目标的网络架构和关键资产。DNS信息包括注册的名称服务器、子域名、邮件服务器（MX记录）、其他主机地址（A/AAAA记录）以及相关的TXT或CNAME记录等。这些信息可帮助攻击者识别目标的网络入口点、基础设施分布或潜在漏洞。

攻击者可能通过以下方式收集DNS信息：
- **被动DNS查询**：利用公开DNS数据库或历史记录（如SecurityTrails、DNS Dumpster）获取目标的域名解析历史。
- **主动DNS查询**：直接查询目标域名的DNS记录（如使用dig、nslookup）。
- **公开信息收集**：通过搜索引擎、社交媒体或泄露文档获取与DNS相关的配置信息。
- **社会工程**：通过钓鱼或伪装身份诱导员工泄露DNS相关信息（如管理凭据）。

收集到的DNS信息可能为后续攻击活动做准备，例如主动扫描（T1595）、搜索开放网站/域（T1593）、建立运营资源（T1583/T1584）或利用外部远程服务实现初始访问（T1133）。

## 测试案例

以下是模拟攻击者收集DNS信息的常见方法和工具：
- **被动DNS查询**：
  - **SecurityTrails** (<https://securitytrails.com>): 查询目标域名的历史DNS记录，包括IP地址、子域名和机房信息。
  - **DNS Dumpster** (<https://dnsdumpster.com>): 提供目标域名的DNS映射和子域名信息。
  - **ViewDNS.info** (<https://viewdns.info>): 获取DNS历史记录，追踪域名解析变更。
  - **DNSDB** (<https://www.dnsdb.info>): 全球DNS搜索引擎，查询目标域名的历史和当前记录。
- **主动DNS查询**：
  - **dig/nslookup**: 直接查询目标域名的A、MX、NS、TXT等记录。
  - **dnsenum**: 自动化枚举目标域名的子域名和DNS记录。
  - **Fierce**: 用于DNS枚举和子域名爆破的工具。
- **在线查询平台**：
  - **ThreatBook** (<https://www.threatbook.io>): 提供DNS和威胁情报分析。
  - **Netcraft** (<https://www.netcraft.com>): 分析目标域名的托管信息和历史记录。
- **社会工程**：
  - 通过伪装成IT管理员发送钓鱼邮件，诱导员工泄露DNS管理平台的凭据。
  - 在论坛或社交媒体（如QQ群、LinkedIn）收集员工泄露的DNS配置信息。
- **案例场景**：
  - 攻击者通过SecurityTrails查询目标组织的子域名，发现未正确配置的邮件服务器（MX记录），进而发起针对该服务器的攻击。
  - 使用dnsenum枚举子域名，识别隐藏的测试环境（如test.target.com），作为后续入侵的入口。

## 检测日志

DNS信息收集多通过公开数据库或外部查询进行，难以直接监测。以下是可能的日志来源：
- **DNS服务器日志**：
  - 记录异常的DNS查询模式，如来自单一IP的高频查询或针对子域的批量查询。
- **网络流量日志**：
  - 检测外部主机对组织DNS服务器的异常请求（如大量A/NS/MX查询）。
- **Web服务器日志**：
  - 监控与DNS管理平台相关的异常登录尝试或HTTP请求。
- **邮件服务器日志**：
  - 检测钓鱼邮件或社会工程攻击，可能与DNS信息收集相关。

## 测试复现

无标准化复现流程。可通过以下方式模拟：
- **被动收集**：使用SecurityTrails或DNS Dumpster查询目标组织的DNS记录，记录子域名和历史IP。
- **主动查询**：在授权测试环境中，使用dig或dnsenum枚举目标域名的子域名和记录。
- **社会工程模拟**：在红队测试中，伪装成第三方服务提供商，诱导员工泄露DNS管理信息。
- **综合测试**：结合FOFA/Shodan搜索与目标域名关联的外部资产，推测DNS配置。

## 测试留痕
- **被动DNS查询**：通常不留明显痕迹，难以直接检测。
- **主动DNS查询**：可能在DNS服务器日志中记录异常查询流量。
- **社会工程**：可能在邮件服务器或员工设备上留下钓鱼交互记录。
- **DNS管理平台**：异常登录尝试可能在管理平台日志中记录。

## 测试留痕

由于DNS信息收集多发生在目标组织视野之外，检测需结合多种手段：
- **DNS查询监控**：
  - 配置DNS服务器记录查询日志，检测异常的高频查询或针对敏感子域的请求。
  - 使用DNS防火墙（如Cloudflare Gateway）阻止已知的恶意查询来源。
- **网络流量分析**：
  - 部署IDS/IPS（如Snort、Suricata）监控异常DNS流量，如来自单一IP的批量查询。
  - 使用Zeek或NetFlow分析DNS请求模式，识别潜在的枚举行为。
- **信息泄露防护**：
  - 使用DLP（数据丢失防护）工具，检测员工通过邮件或社交媒体泄露DNS相关信息。
  - 监控公开信息源（如Pastebin、暗网论坛）中是否出现组织的DNS记录。
- **威胁情报整合**：
  - 结合威胁情报平台（如ThreatBook），识别已知的DNS侦察工具或恶意IP。
  - 定期检查第三方DNS数据库（如SecurityTrails）中的记录，评估信息暴露风险。

### 建议
- **减少信息暴露**：
  - 使用WHOIS隐私保护服务，隐藏域名注册信息。
  - 定期清理或限制公开DNS记录，避免暴露敏感子域名或服务器信息。
  - 对员工进行安全意识培训，防止通过社会工程泄露DNS管理凭据。
- **DNS安全加固**：
  - 实施DNSSEC（DNS安全扩展）以防止DNS欺骗和篡改。
  - 限制DNS管理平台的访问，仅允许白名单IP登录。
  - 定期审计DNS记录，删除未使用的子域名或记录。
- **主动监控与响应**：
  - 部署DNS日志分析工具（如Splunk、ELK），监控异常查询行为。
  - 使用威胁狩猎（Threat Hunting）技术，主动搜索可能的DNS侦察活动。
  - 定期审查第三方服务提供商的DNS配置，确保其安全性。
- **后续阶段检测**：
  - 重点监控攻击者生命周期的后续阶段（如初始访问T1133、横向移动T1021），通过异常网络流量或登录行为间接发现DNS侦察活动。

## 参考资料
- MITRE ATT&CK: T1590-002  
  <https://attack.mitre.org/techniques/T1590/002/>
- DNS历史解析与安全  
  <https://www.kancloud.cn/noahs/src_hacker/2120650>
- 渗透测试之信息收集DNS篇  
  <https://blog.csdn.net/qq1124794084/article/details/78672225>