# T1078-003-win-账户登录失败

## 描述

攻击者可能通过凭据访问技术（如凭据窃取、暴力破解或社会工程学）获取特定用户或服务账户的凭据，用于初始访问、持久化、权限提升或防御逃避。攻击者可能针对以下三种账户：
- **默认账户**：操作系统或软件的内置账户，如Windows的Guest或Administrator账户，或其他设备/软件的默认提供商账户。
- **本地账户**：由组织配置，用于用户、远程支持、服务或单个系统/服务的管理。
- **域账户**：由活动目录域服务（AD-DS）管理，权限跨域内多个系统和服务。

攻击者可能滥用本地账户凭据，通过操作系统凭据导出（如提取SAM数据库中的哈希）实现权限提升或收集更多凭据。密码重用或弱密码策略可能导致多台设备上的本地账户被滥用，为攻击者提供横向移动或提权的机会。来自单一源系统的多次登录失败可能表明攻击者正在尝试暴力破解、凭据填充或测试窃取的账户。

## 测试案例

1. **暴力破解本地账户**  
   攻击者从单一源IP使用多个用户名和密码组合尝试登录Windows系统，触发多次登录失败事件（事件ID 4625）。

2. **凭据填充攻击**  
   攻击者使用从数据泄露中获取的凭据列表，尝试登录域账户或本地账户，导致同一工作站记录多个账户的登录失败。

## 检测日志

**Windows安全日志**  
检测账户登录失败行为依赖Windows安全日志中的以下事件：
- **登录失败事件**：
  - Windows Vista及更高版本：事件ID 4625（本地账户登录失败）。
  - Windows XP及更早版本：事件ID 529（登录失败）。
  - 域账户登录失败：事件ID 4776（适用于域控制器上的NTLM认证）。
- **登录成功事件**（辅助分析）：事件ID 4624，记录成功登录，用于对比异常登录模式。
- **注销事件**（辅助分析）：事件ID 4634，记录用户注销，协助分析登录会话。

## 测试复现

1. **环境准备**：
   - 配置一台Windows测试主机，启用安全日志审核（事件ID 4625、4776）。
   - 创建多个本地账户或配置域环境，模拟真实场景。

2. **模拟登录失败**：
   - 从单一源系统（如测试工作站）使用错误凭据多次尝试登录本地或域账户。
   - 示例PowerShell脚本（模拟登录失败）：
     ```powershell
     $users = @("user1", "user2", "user3")
     foreach ($user in $users) {
         $credential = New-Object System.Management.Automation.PSCredential($user, (ConvertTo-SecureString "WrongPassword" -AsPlainText -Force))
         try { Enter-PSSession -ComputerName <Target_IP> -Credential $credential } catch { Write-Output "Login failed for $user" }
     }
     ```

3. **验证日志**：
   - 检查Windows事件查看器中的安全日志，确认事件ID 4625或4776记录，验证是否记录多个账户的登录失败及源工作站信息。

**注意**：此复现仅用于学习和测试目的，需在合法授权的测试环境中进行，切勿用于非法活动。

## 测试留痕

账户登录失败可能在以下日志中留下痕迹：
- **Windows安全日志**：
  - 事件ID 4625：记录本地账户登录失败，包含源IP、账户名和失败原因。
  - 事件ID 4776：记录域账户NTLM认证失败，包含工作站名和账户信息。
- **网络日志**：防火墙或IDS/IPS可能记录来自单一源的多次登录尝试。
- **服务日志**：远程服务（如RDP）可能记录登录失败的详细信息。

## 检测规则/思路

**检测规则**  
通过分析Windows安全日志，检测单一源系统在短时间内（例如24小时）尝试多个账户登录失败的行为。以下是具体思路：

1. **日志分析**：
   - 收集事件ID 4625（本地账户登录失败）和4776（域账户登录失败）的日志。
   - 按工作站名分组，统计唯一账户数量，检测异常模式（如单一源尝试多个账户）。

2. **Sigma规则**：
   ```yaml
   title: 从单一源系统使用不同账户登录失败
   id: 8b4e6c3a-9f2d-4a1e-b7c5-2e9a8d4f6e3b
   description: 检测单一源系统尝试多个用户账户登录失败，可能表明暴力破解或凭据填充。
   date: 2020/06/09
   tags:
     - attack.persistence
     - attack.privilege_escalation
     - attack.t1078.003
   logsource:
     product: windows
     service: security
   detection:
     selection1:
       EventID:
         - 4625 # Windows Vista及以上，登录失败
         - 529 # Windows 2003及以下，登录失败
       UserName: '*'
       WorkstationName: '*'
     selection2:
       EventID: 4776 # 域账户NTLM认证失败
       UserName: '*'
       Workstation: '*'
     timeframe: 24h
     condition:
       - selection1 | count(UserName) by WorkstationName > 3
       - selection2 | count(UserName) by Workstation > 3
   falsepositives:
     - 终端服务器或Citrix服务器场等多用户系统
     - 用户频繁切换账户的工作站
     - 合法的测试或管理活动
   level: medium
   ```

3. **SIEM规则**：
   - 在SIEM系统中设置告警，检测单一工作站在24小时内尝试登录的账户数超过阈值。
   - 示例Splunk查询：
     ```spl
     source="WinEventLog:Security" EventCode IN (4625, 529, 4776) | bucket _time span=24h | stats dc(Account_Name) as user_count by Workstation_Name | where user_count > 3
     ```

4. **威胁情报整合**：
   - 检查登录失败事件的源IP或工作站是否与已知恶意活动相关，结合威胁情报平台（如VirusTotal、ThreatConnect）。

## 建议

### 缓解措施

由于账户登录失败可能表明攻击者尝试利用有效账户，防御需从凭据保护和访问控制入手：

1. **凭据保护**  
   - 实施强密码策略，强制使用复杂密码并定期更换。  
   - 启用多因素认证（MFA），降低凭据被盗后的风险。  
   - 示例：为RDP或VPN启用MFA。

2. **账户锁定策略**  
   - 配置账户锁定策略，限制登录失败次数（如5次失败后锁定账户30分钟）。  
   - 示例Windows组策略设置：
     - 路径：`计算机配置->Windows设置->安全设置->账户策略->账户锁定策略`

3. **访问控制**  
   - 限制本地账户和域账户的使用，仅允许必要用户和服务账户访问特定系统。  
   - 使用最小权限原则，减少高权限账户的暴露。

4. **网络安全控制**  
   - 配置防火墙规则，限制远程服务（如RDP的3389端口）的访问，仅允许白名单IP。  
   - 使用入侵防御系统（IPS）检测暴力破解或凭据填充尝试。

5. **用户教育**  
   - 培训用户识别鱼叉式网络钓鱼或社会工程学攻击，避免泄露凭据。  
   - 教授用户定期检查账户活动，报告异常登录尝试。

### 检测

检测工作应集中在登录失败的异常行为上，包括但不限于：  
- **登录失败监控**：分析Windows安全日志（事件ID 4625、4776），检测单一源尝试多个账户登录失败的行为。  
- **异常模式识别**：通过SIEM或EDR工具，识别高频登录失败或来自可疑IP/workstation的尝试。  
- **行为分析**：监控与登录失败相关的后续行为，如凭据导出（事件ID 4672、4673）或异常进程启动。  
- **威胁情报整合**：利用威胁情报平台，关联登录失败的源IP或账户是否与已知恶意活动相关。

### 建议阈值调整

- **根据业务需求调整阈值**：默认规则中阈值为单一源24小时内尝试超过3个账户，可根据实际环境（如多用户系统或高频登录场景）调整为更高阈值（如5个账户）。
- **排除误报**：识别合法多用户场景（如终端服务器、Citrix环境），通过白名单排除误报。

## 参考推荐

- MITRE ATT&CK: T1078-003  
  <https://attack.mitre.org/techniques/T1078/003/>
