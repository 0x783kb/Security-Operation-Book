# T1110.003-Win-密码喷射

## 描述

密码喷射（PasswordSpraying）是一种暴力破解技术，攻击者使用单一或少量常见密码（如“Password01”）尝试登录多个用户账户，以规避账户锁定策略。相比传统暴力破解（针对单一账户尝试多个密码），密码喷射针对多个账户使用相同密码，避免触发登录失败阈值。攻击者通常利用社交工程、网络钓鱼或其他方式收集用户ID，并结合域密码策略选择可能密码，攻击常见服务如RDP（3389/TCP）、SMB（445/TCP）、LDAP（389/TCP）、Kerberos（88/TCP）等。成功登录后，攻击者可获取未授权访问权限，甚至进一步横向移动。

## 测试案例

**测试环境**：
- 域控制器：WindowsServer2016/2019
- 域内主机：Windows10
- 工具：Hydra、Ncrack、CrackMapExec
- 要求：域用户列表、常见密码列表、域控制器地址、域密码策略（如锁定阈值5次，锁定窗口30分钟）

**测试准备**：
1. 收集域用户列表（通过LDAP查询或钓鱼获取）。
2. 准备常见密码列表（如“Password123”、“Summer2025”）。
3. 确认域密码策略（锁定阈值、锁定窗口）。
4. 安装工具：Hydra（KaliLinux）、Ncrack（KaliLinux）、CrackMapExec（Python环境）。

**测试步骤**：
1. **场景一：Hydra进行RDP密码喷射**：
   ```bash
   hydra-Lusers.txt-pPassword123rdp://dc.lab.local-t4-w30
   ```
   - `-Lusers.txt`：用户列表文件
   - `-pPassword123`：单一测试密码
   - `-t4`：并发线程数（低于锁定阈值）
   - `-w30`：等待30秒避免锁定
   输出示例：
   ```
   [3389][rdp]host:dc.lab.locallogin:testuserpassword:Password123
   ```

2. **场景二：Ncrack进行RDP密码喷射**：
   ```bash
   ncrack-uusers.txt-pPassword123-T3rdp://dc.lab.local--pairwise
   ```
   - `-T3`：降低扫描速度
   - `--pairwise`：逐对尝试，避免锁定
   输出示例：
   ```
   Discoveredcredentials:testuserPassword123
   ```

3. **场景三：CrackMapExec进行SMB密码喷射**：
   ```bash
   crackmapexecsmbdc.lab.local-uusers.txt-pPassword123--continue-on-success
   ```
   输出示例：
   ```
   [+]dc.lab.localtestuser:Password123(Pwn3d!)
   ```

**参考资源**：
- 内网渗透之PTH&PTT&PTK：<https://www.bbsmax.com/A/A7zgkjRPz4/>
- CrackMapExec文档：<https://mpgn.gitbook.io/crackmapexec/>
- Hydra使用指南：<https://www.jianshu.com/p/4da49f179cee>

## 检测日志

**数据来源**：
- **Windows安全日志**：
  - 域控制器：事件ID4625（登录失败）、4771（Kerberos预身份验证失败）
  - 所有系统：事件ID4648（使用显式凭据登录）
- **Sysmon日志**（可选）：
  - 事件ID1（进程创建，监控Hydra/Ncrack/CME）
  - 事件ID3（网络连接，捕获RDP/SMB/LDAP流量）
- **网络流量**：捕获RDP（3389/TCP）、SMB（445/TCP）、LDAP（389/TCP）、Kerberos（88/TCP）异常登录尝试。

**关键日志字段**：
- 事件ID4625：`FailureReason`（“未知用户名或密码错误”）、`Status`（0xc000006d）、`SubStatus`（0xc0000064）、`LogonType`（3或10）。
- 事件ID4771：`FailureCode`（0x18，密码错误）、`SuppliedRealmName`、`TargetUserName`。
- 事件ID4648：`AccountName`（显式凭据使用）、`TargetServerName`。

## 测试复现

**环境配置**：
- 域控制器：WindowsServer2019（dc.lab.local）
- 域内主机：Windows10
- 工具：Hydra、Ncrack
- 用户列表：`users.txt`（testuser1,testuser2,...）
- 密码：`Password123`
- 域策略：锁定阈值5次，锁定窗口30分钟

**复现步骤**：
1. **HydraRDP密码喷射**：
   ```bash
   hydra-Lusers.txt-pPassword123rdp://dc.lab.local-t4-w30
   ```
   输出示例：
   ```
   [3389][rdp]host:dc.lab.locallogin:testuser1password:Password123
   ```
2. **NcrackRDP密码喷射**：
   ```bash
   ncrack-uusers.txt-pPassword123-T3rdp://dc.lab.local--pairwise
   ```
   输出示例：
   ```
   Discoveredcredentials:testuser1Password123
   ```
3. 验证日志：
   - 域控制器：检查事件ID4625（登录失败）、4771（Kerberos失败）。
   - 域内主机：检查事件ID4648（显式凭据登录）。

## 测试留痕

**Windows安全日志（域控制器）**：
- **事件ID4625**（登录失败，RDP）：
  ```xml
  <Event>
    <EventData>
      <DataName="TargetUserName">testuser1</Data>
      <DataName="TargetDomainName">LAB</Data>
      <DataName="FailureReason">未知用户名或密码错误。</Data>
      <DataName="Status">0xc000006d</Data>
      <DataName="SubStatus">0xc0000064</Data>
      <DataName="LogonType">10</Data>
      <DataName="LogonProcessName">User32</Data>
      <DataName="AuthenticationPackageName">Negotiate</Data>
    </EventData>
  </Event>
  ```
- **事件ID4771**（Kerberos预身份验证失败，LDAP）：
  ```xml
  <Event>
    <EventData>
      <DataName="TargetUserName">testuser1</Data>
      <DataName="SuppliedRealmName">LAB</Data>
      <DataName="FailureCode">0x18</Data>
    </EventData>
  </Event>
  ```
- **事件ID4648**（显式凭据登录，域内主机）：
  ```xml
  <Event>
    <EventData>
      <DataName="AccountName">testuser1</Data>
      <DataName="TargetServerName">dc.lab.local</Data>
    </EventData>
  </Event>
  ```

**Sysmon日志**（可选）：
- 事件ID1（进程创建，Hydra/Ncrack）：
  ```xml
  <Event>
    <EventData>
      <DataName="Image">/usr/bin/hydra</Data>
      <DataName="CommandLine">hydra-Lusers.txt-pPassword123rdp://dc.lab.local</Data>
    </EventData>
  </Event>
  ```

## 检测规则/思路

### Sigma规则

**场景一：HydraRDP/SMB密码喷射**：
```yaml
title:HydraRDP或SMB密码喷射检测
id:a1b2c3d4-5e6f-4a3b-9c8d-4e5f6a7b8c9d
status:stable
description:检测使用Hydra进行RDP或SMB密码喷射攻击，关注多用户登录失败
references:
  -https://attack.mitre.org/techniques/T1110/003/
  -https://www.96007.club/2019/09/17/Credential-Access-win-Password-spraying/
tags:
  -attack.credential_access
  -attack.t1110.003
logsource:
  product:windows
  service:security
detection:
  selection_4625:
    EventID:4625
    LogonType|in:
      -3
      -10
    FailureReason:'未知用户名或密码错误。'
    Status:0xc000006d
    SubStatus:0xc0000064
    AuthenticationPackageName|in:
      -NTLM
      -Negotiate
  selection_4771:
    EventID:4771
    FailureCode:0x18
  timeframe:60s
  condition:(selection_4625orselection_4771)|count(TargetUserName)bySourceWorkstation>50
fields:
  -EventID
  -TargetUserName
  -TargetDomainName
  -SourceWorkstation
  -FailureCode
  -LogonType
falsepositives:
  -合法用户多次尝试错误密码
  -管理员测试账户登录
level:high
```

**场景二：NcrackRDP密码喷射**：
```yaml
title:NcrackRDP密码喷射检测
id:b2c3d4e5-6f7a-4b4b-ac9d-5f6a7b8c9d0e
status:stable
description:检测使用Ncrack进行RDP密码喷射攻击，关注多用户登录失败
references:
  -https://attack.mitre.org/techniques/T1110/003/
  -https://www.96007.club/2019/09/17/Credential-Access-win-Password-spraying/
tags:
  -attack.credential_access
  -attack.t1110.003
logsource:
  product:windows
  service:security
detection:
  selection_4625:
    EventID:4625
    LogonType:10
    FailureReason:'未知用户名或密码错误。'
    Status:0xc000006d
    SubStatus:0xc0000064
    CallerProcessName:'C:\Windows\System32\winlogon.exe'
    LogonProcessName:'User32'
    AuthenticationPackageName:'Negotiate'
  timeframe:60s
  condition:selection_4625|count(TargetUserName)bySourceWorkstation>50
fields:
  -EventID
  -TargetUserName
  -SourceWorkstation
  -CallerProcessName
falsepositives:
  -合法用户多次尝试RDP登录失败
level:high
```

**场景三：显式凭据登录异常**：
```yaml
title:异常显式凭据登录检测
id:c3d4e5f6-7a8b-4c5c-bd0e-6a7b8c9d0e1f
status:stable
description:检测域内主机上异常的显式凭据登录，可能是密码喷射攻击
references:
  -https://attack.mitre.org/techniques/T1110/003/
tags:
  -attack.credential_access
  -attack.t1110.003
logsource:
  product:windows
  service:security
detection:
  selection:
    EventID:4648
    TargetServerName|endswith:'.local'
  timeframe:60s
  condition:selection|count(AccountName)bySourceWorkstation>100
fields:
  -EventID
  -AccountName
  -TargetServerName
  -SourceWorkstation
falsepositives:
  -管理员批量测试账户
  -自动化脚本使用显式凭据
level:medium
```

### 检测思路

1. **日志监控**：
   - 监控域控制器事件ID4625（登录失败）、4771（Kerberos失败），关注多用户、单一来源的失败模式。
   - 监控域内主机事件ID4648，检测短时间内大量显式凭据登录。

2. **网络监控**：
   - 使用IDS/IPS捕获RDP（3389/TCP）、SMB（445/TCP）、LDAP（389/TCP）异常流量。
   - 示例Snort规则：
     ```snort
     alerttcpanyany->any3389(msg:"RDPPasswordSprayAttempt";content:"AUTH";threshold:typet hreshold,trackby_src,count50,seconds60;sid:1000003;)
     ```

3. **行为分析**：
   - 检测单一来源IP或主机短时间内尝试多个用户账户。
   - 结合Sysmon事件ID1，监控Hydra/Ncrack/CME进程执行。

4. **策略检查**：
   - 定期审查域密码策略，确保锁定阈值和窗口合理（建议阈值5次，窗口30分钟）。

## 防御建议

1. **强化密码策略**：
   - 强制复杂密码（长度≥12，包含大小写、数字、特殊字符）。
   - 设置合理锁定策略（如5次失败锁定30分钟）。

2. **限制服务暴露**：
   - 限制RDP/SMB/LDAP外部访问，使用VPN或防火墙过滤。
   - 禁用不必要的服务端口（如Telnet、NetBIOS）。

3. **日志与监控**：
   - 启用事件ID4625、4771、4648的成功和失败审计。
   - 部署Sysmon，监控进程和网络行为。
   - 使用SIEM（如Splunk）关联多用户登录失败事件。

4. **多因素认证（MFA）**：
   - 为RDP、LDAP等服务启用MFA，增加攻击难度。

5. **主动防御**：
   - 部署诱捕账户（HoneyAccounts），监控异常登录尝试。
   - 使用EDR工具检测Hydra/Ncrack/CME等工具执行。

## 参考推荐

- MITREATT&CK:BruteForce:PasswordSpraying(T1110.003)  
  <https://attack.mitre.org/techniques/T1110/003/>
- LDAP轻量目录访问协议  
  <https://baike.baidu.com/item/LDAP/2875565>
- Hydra使用指南  
  <https://www.jianshu.com/p/4da49f179cee>
- CrackMapExec文档  
  <https://mpgn.gitbook.io/crackmapexec/>
- ActiveDirectory密码喷射检测  
  <https://www.96007.club/2019/09/17/Credential-Access-win-Password-spraying/>