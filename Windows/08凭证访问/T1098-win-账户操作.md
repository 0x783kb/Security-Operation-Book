# T1098-Win-账户操作

## 描述

账户操作（AccountManipulation）是指攻击者通过修改账户权限、凭据、权限组、账户设置或身份验证方式，以维持对系统或域的持久化访问。攻击者可能通过创建新账户、修改现有账户权限、添加用户到高权限组（如DomainAdmins）或更改密码来实现目标。执行账户操作需要攻击者已具备系统或域的足够权限（如管理员或域管理员权限）。此技术常用于权限提升、持久化或横向移动。

## 测试案例

**测试环境**：
- 系统：WindowsServer2016/2019（域控制器）或Windows10（本地主机）
- 工具：CMD、PowerShell、Mimikatz
- 要求：管理员或域管理员权限、启用Windows安全日志审计
- 域环境：lab.local，域控制器dc.lab.local

**测试准备**：
1. 确保具备管理员或域管理员权限（通过域用户或本地管理员账户登录）。
2. 启用Windows安全日志审计（组策略：计算机配置>策略>Windows设置>安全设置>本地策略>审核策略>账户管理）。
3. 准备测试账户（如testuser）或权限组（如DomainAdmins）。

**测试步骤**：
1. **创建本地用户**：
   ```cmd
   netusertestuserTest@123/add
   ```
2. **添加用户到本地管理员组**：
   ```cmd
   netlocalgroupAdministratorstestuser/add
   ```
3. **创建域用户（域控制器）**：
   ```cmd
   netusertestuserTest@123/add/domain
   ```
4. **添加用户到域管理员组**：
   ```cmd
   netgroup"DomainAdmins"testuser/add/domain
   ```
5. **使用PowerShell修改用户密码**：
   ```powershell
   Set-ADAccountPassword-Identitytestuser-NewPassword(ConvertTo-SecureString"NewPass@456"-AsPlainText-Force)
   ```
6. **使用Mimikatz修改账户权限**：
   ```cmd
   mimikatz.exe"privilege::debug""sid::patch""sid::add/sid:S-1-5-21-1473643419-774954089-2222329127-1000/group:DomainAdmins"exit
   ```

**参考资源**：
- Mimikatz文档：<https://github.com/gentilkiwi/mimikatz>
- Windows账户管理命令：<https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/net-user>

## 检测日志

**数据来源**：
- **Windows安全日志**：
  - 事件ID4720：用户账户创建
  - 事件ID4722：用户账户启用
  - 事件ID4728：用户添加到安全组
  - 事件ID4732：用户添加到本地安全组
  - 事件ID4738：用户账户更改（如密码重置）
- **Sysmon日志**（可选）：
  - 事件ID1：进程创建（监控net.exe、powershell.exe、mimikatz.exe）
  - 事件ID13：注册表修改（账户相关注册表键）
- **PowerShell日志**：
  - 事件ID4103/4104：PowerShell命令执行

**关键日志字段**：
- 事件ID4720：`TargetAccount`（新用户）、`CallerUserName`（操作者）
- 事件ID4728/4732：`MemberName`（添加的用户）、`GroupName`（目标组）
- 事件ID4738：`TargetAccount`（修改账户）、`ChangedAttributes`（更改内容）
- 事件ID4688：`ProcessName`（net.exe/powershell.exe）、`CommandLine`

## 测试复现

**环境配置**：
- 域控制器：WindowsServer2019（dc.lab.local）
- 域内主机：Windows10
- 用户：testuser，密码Test@123
- 权限：域管理员或本地管理员

**复现步骤**：
1. 创建本地用户：
   ```cmd
   C:\Windows\system32>netusertestuserTest@123/add
   命令成功完成。
   ```
2. 添加到本地管理员组：
   ```cmd
   C:\Windows\system32>netlocalgroupAdministratorstestuser/add
   命令成功完成。
   ```
3. 创建域用户并添加到DomainAdmins：
   ```cmd
   C:\Windows\system32>netusertestuserTest@123/add/domain
   C:\Windows\system32>netgroup"DomainAdmins"testuser/add/domain
   命令成功完成。
   ```
4. 使用PowerShell修改密码：
   ```powershell
   Set-ADAccountPassword-Identitytestuser-NewPassword(ConvertTo-SecureString"NewPass@456"-AsPlainText-Force)
   ```
5. 验证日志：检查域控制器或本地主机的事件ID4720、4728、4732、4738。

## 测试留痕

**Windows安全日志（域控制器/本地主机）**：
- **事件ID4720**（用户账户创建）：
  ```xml
  <Event>
    <EventData>
      <DataName="TargetUserName">testuser</Data>
      <DataName="TargetDomainName">LAB</Data>
      <DataName="SubjectUserName">admin</Data>
      <DataName="SubjectDomainName">LAB</Data>
    </EventData>
  </Event>
  ```
- **事件ID4728**（用户添加到安全组，域环境）：
  ```xml
  <Event>
    <EventData>
      <DataName="MemberName">CN=testuser,CN=Users,DC=lab,DC=local</Data>
      <DataName="GroupName">DomainAdmins</Data>
      <DataName="SubjectUserName">admin</Data>
    </EventData>
  </Event>
  ```
- **事件ID4732**（用户添加到本地安全组）：
  ```xml
  <Event>
    <EventData>
      <DataName="MemberName">testuser</Data>
      <DataName="GroupName">Administrators</Data>
      <DataName="SubjectUserName">admin</Data>
    </EventData>
  </Event>
  ```
- **事件ID4738**（用户账户更改）：
  ```xml
  <Event>
    <EventData>
      <DataName="TargetUserName">testuser</Data>
      <DataName="TargetDomainName">LAB</Data>
      <DataName="ChangedAttributes">Password</Data>
      <DataName="SubjectUserName">admin</Data>
    </EventData>
  </Event>
  ```
- **事件ID4688**（进程创建，net.exe）：
  ```xml
  <Event>
    <EventData>
      <DataName="ProcessName">C:\Windows\System32\net.exe</Data>
      <DataName="CommandLine">netusertestuserTest@123/add</Data>
      <DataName="SubjectUserName">admin</Data>
    </EventData>
  </Event>
  ```

**Sysmon日志**（可选）：
- 事件ID1（进程创建）：
  ```xml
  <Event>
    <EventData>
      <DataName="Image">C:\Windows\System32\net.exe</Data>
      <DataName="CommandLine">netusertestuserTest@123/add</Data>
      <DataName="User">LAB\admin</Data>
    </EventData>
  </Event>
  ```

## 检测规则/思路

### Sigma规则

**规则一：检测net.exe创建用户或添加组**：
```yaml
title:Net.exe账户操作检测
id:d4e5f6a7-8b9c-4d5e-be0f-7a8b9c0d1e2a
status:stable
description:检测使用net.exe或net1.exe创建用户或添加用户到权限组的行为
references:
  -https://attack.mitre.org/techniques/T1098/
tags:
  -attack.persistence
  -attack.t1098
logsource:
  category:process_creation
  product:windows
detection:
  selection:
    EventID|in:
      -4688
      -1
    Image|endswith:
      -'\net.exe'
      -'\net1.exe'
    CommandLine|contains|all:
      -'user'
      -'/add'
  selection_group:
    EventID|in:
      -4688
      -1
    Image|endswith:
      -'\net.exe'
      -'\net1.exe'
    CommandLine|contains|all:
      -'group'
      -'/add'
      -'Administrators'
      -'DomainAdmins'
  condition:selectionorselection_group
fields:
  -ComputerName
  -User
  -CommandLine
  -Image
falsepositives:
  -管理员合法创建用户或修改组
level:medium
```

**规则二：检测账户创建或修改事件**：
```yaml
title:账户创建或修改检测
id:e5f6a7b8-9c0d-4e6f-bf1a-8c9d0e1f2b3c
status:stable
description:检测用户账户创建或权限组修改行为
references:
  -https://attack.mitre.org/techniques/T1098/
tags:
  -attack.persistence
  -attack.t1098
logsource:
  category:security
  product:windows
detection:
  selection_create:
    EventID:4720
    TargetUserName|notcontains:
      -'$'
      -'krbtgt'
  selection_group:
    EventID|in:
      -4728
      -4732
    GroupName|in:
      -'Administrators'
      -'DomainAdmins'
  selection_modify:
    EventID:4738
    ChangedAttributes|contains:'Password'
  condition:selection_createorselection_grouporselection_modify
fields:
  -EventID
  -TargetUserName
  -GroupName
  -SubjectUserName
falsepositives:
  -管理员合法账户管理操作
level:high
```

**规则优化说明**：
- 规则一：聚焦`net.exe`/`net1.exe`的账户创建和组添加行为，覆盖本地和域环境。
- 规则二：监控账户创建（4720）、组修改（4728/4732）、密码更改（4738），排除服务账户（如krbtgt）降低误报。
- 添加关键字段映射，便于关联分析。

### 检测思路

1. **日志监控**：
   - 监控事件ID4720、4728、4732、4738，关注非预期用户创建或高权限组（如DomainAdmins）修改。
   - 检查事件ID4688，检测`net.exe`、`powershell.exe`或`mimikatz.exe`的异常命令行。

2. **行为分析**：
   - 检测非管理员用户执行账户操作（如创建用户、修改组）。
   - 监控短时间内多次账户创建或权限提升事件。

3. **Sysmon增强**：
   - 使用Sysmon事件ID1监控`net.exe`和`powershell.exe`命令行。
   - 事件ID13监控账户相关注册表键（如SAM数据库）更改。

4. **关联分析**：
   - 结合事件ID4624（登录成功）与4720/4728，检测新创建账户的异常登录。
   - 使用SIEM关联多事件，识别账户操作模式。

## 防御建议

1. **权限最小化**：
   - 限制普通用户对账户管理的权限，仅授权管理员执行操作。
   - 使用组策略限制对SAM数据库和组策略对象的访问。

2. **日志与监控**：
   - 启用账户管理审计（事件ID4720、4728、4732、4738）。
   - 部署Sysmon，监控进程和注册表行为。
   - 使用SIEM（如Splunk）检测异常账户操作模式。

3. **多因素认证（MFA）**：
   - 为管理员账户启用MFA，防止凭据被滥用。
   - 对高权限操作（如组修改）实施二次验证。

4. **安全策略**：
   - 定期审查用户账户和权限组，清理不必要的高权限账户。
   - 限制`net.exe`和PowerShell的非管理员执行（通过AppLocker或WDAC）。

5. **主动防御**：
   - 部署诱捕账户（HoneyAccounts），监控异常账户操作。
   - 使用EDR工具检测Mimikatz等工具的执行或异常进程行为。

## 参考推荐

- MITREATT&CK:AccountManipulation(T1098)  
  <https://attack.mitre.org/techniques/T1098/>
- Windows账户管理命令  
  <https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/net-user>
- Mimikatz文档  
  <https://github.com/gentilkiwi/mimikatz>
- ActiveDirectory安全最佳实践  
  <https://adsecurity.org/?p=1684>