# T1078-003-有效账户-来自公网的登录失败行为

## 描述

攻击者可能利用面向外部的远程服务（如VPN、Citrix、远程桌面或Windows Remote Management）实现初始访问或在网络内建立持久化。这些服务通常通过远程服务网关管理连接和凭据身份验证。攻击者可能通过凭据窃取、暴力破解或从被攻陷的企业网络中获取有效账户，以访问这些服务。成功利用远程服务可为攻击者提供冗余或持久的访问机制，绕过传统防御措施。

来自公网的登录失败行为可能表明攻击者正在尝试暴力破解、凭据填充或测试窃取的账户。此类行为可能暴露防火墙或网络边界配置的错误，允许未经授权的公网IP访问内部服务。检测此类行为有助于识别潜在的攻击尝试或配置问题。

## 测试案例

1. **暴力破解尝试**  
   攻击者从公网IP对远程桌面服务（RDP）发起多次登录尝试，使用不同账户和密码组合，导致多次登录失败事件。

2. **凭据填充攻击**  
   攻击者使用从数据泄露中获取的凭据列表，尝试登录组织的VPN或Citrix服务，触发大量登录失败记录。

## 检测日志

**Windows安全日志**  
检测登录失败行为依赖Windows安全日志中的以下事件：
- **登录失败事件**：事件ID 4625（Windows Vista及更高版本），记录账户登录失败的详细信息，包括源IP地址、账户名和失败原因。
- **登录成功事件**（辅助分析）：事件ID 4624，记录成功登录，可用于对比异常登录模式。
- **注销事件**（辅助分析）：事件ID 4634，记录用户注销，协助分析登录会话。

## 测试复现

1. **环境准备**：
   - 配置一台Windows测试主机，启用RDP或VPN服务，并开启安全日志审核（事件ID 4625）。
   - 确保主机可从公网访问（模拟暴露的远程服务）。

2. **模拟公网登录失败**：
   - 从外部网络（公网IP）使用错误凭据尝试登录RDP或VPN服务，触发登录失败事件。
   - 示例PowerShell脚本（模拟RDP登录尝试）：
     ```powershell
     $credential = New-Object System.Management.Automation.PSCredential("testuser", (ConvertTo-SecureString "WrongPassword" -AsPlainText -Force))
     try { Enter-PSSession -ComputerName <Target_IP> -Credential $credential } catch { Write-Output "Login failed" }
     ```

3. **验证日志**：
   - 检查Windows事件查看器中的安全日志，确认事件ID 4625记录，验证源IP为公网地址（如非私有IP范围）。

**注意**：此复现仅用于学习和测试目的，需在合法授权的测试环境中进行，切勿用于非法活动。

## 测试留痕

登录失败行为可能在以下日志中留下痕迹：
- **Windows安全日志**：事件ID 4625，记录登录失败的详细信息，包括：
  - 源IP地址（公网IP）。
  - 目标账户名。
  - 失败原因（如错误密码、账户锁定）。
- **网络日志**：防火墙或IDS/IPS可能记录来自公网IP的异常连接尝试。
- **服务日志**：VPN或RDP服务日志可能记录登录失败的详细信息。

## 检测规则/思路

**检测规则**  
通过分析Windows安全日志，检测来自公网IP的登录失败行为，排除私有IP范围（如10.0.0.0/8、192.168.0.0/16）。以下是具体思路：

1. **日志分析**：
   - 收集事件ID 4625的日志，提取源IP地址、账户名和时间戳。
   - 过滤非私有IP地址，识别来自公网的登录尝试。

2. **Sigma规则**：
   ```yaml
   title: 来自公网的登录失败行为
   id: 7a2b5f7d-3c8e-4f6b-9a1a-5f4e6e0c7b2d
   description: 检测来自公网IP的登录失败事件，可能表明暴力破解、凭据填充或网络配置错误。
   author: NVISO, 12306Br0 (翻译+测试)
   date: 2020/05/06
   tags:
     - attack.initial_access
     - attack.persistence
     - attack.t1078
     - attack.t1190
     - attack.t1133
   logsource:
     product: windows
     service: security
   detection:
     selection:
       EventID: 4625 # 登录失败
     unknown:
       IpAddress|contains: '-'
     privatev4:
       IpAddress|startswith:
         - '10.' # 10.0.0.0/8
         - '192.168.' # 192.168.0.0/16
         - '172.16.' # 172.16.0.0/12
         - '172.17.'
         - '172.18.'
         - '172.19.'
         - '172.20.'
         - '172.21.'
         - '172.22.'
         - '172.23.'
         - '172.24.'
         - '172.25.'
         - '172.26.'
         - '172.27.'
         - '172.28.'
         - '172.29.'
         - '172.30.'
         - '172.31.'
         - '127.' # 127.0.0.0/8
         - '169.254.' # 169.254.0.0/16
     privatev6:
       IpAddress:
         - '::1' # IPv6 loopback
         - 'fe80::' # link-local
         - 'fc00::' # unique local
     condition: selection and not (unknown or privatev4 or privatev6)
   falsepositives:
     - 合法的公网登录尝试（如远程员工使用VPN）。
     - IPv4到IPv6映射的IP地址。
   level: medium
   ```

3. **SIEM规则**：
   - 在SIEM系统中设置告警，检测来自非私有IP的登录失败事件。
   - 示例Splunk查询：
     ```spl
     source="WinEventLog:Security" EventCode=4625 NOT (src_ip IN ("10.*", "192.168.*", "172.16.*", "172.17.*", "172.18.*", "172.19.*", "172.20.*", "172.21.*", "172.22.*", "172.23.*", "172.24.*", "172.25.*", "172.26.*", "172.27.*", "172.28.*", "172.29.*", "172.30.*", "172.31.*", "127.*", "169.254.*", "::1", "fe80::*", "fc00::*")) | stats count by src_ip, dest, Account_Name
     ```

4. **威胁情报整合**：
   - 检查登录失败事件的源IP是否与已知恶意IP相关，结合威胁情报平台（如VirusTotal、ThreatConnect）。

## 建议

### 缓解措施

由于公网登录失败可能涉及攻击者尝试利用远程服务，防御需从访问控制和配置加固入手：

1. **访问控制**  
   - 限制远程服务（如RDP、VPN）的公网访问，仅允许特定IP范围（如公司VPN白名单）。  
   - 启用多因素认证（MFA）以降低凭据被盗的风险。  
   - 示例：为RDP配置网络级身份验证（NLA）。

2. **防火墙配置**  
   - 配置防火墙规则，阻止未经授权的公网IP访问远程服务端口（如RDP的3389）。  
   - 使用入侵防御系统（IPS）检测暴力破解或凭据填充尝试。

3. **凭据保护**  
   - 实施强密码策略，强制复杂密码并定期更换。  

## 参考推荐

- MITRE-ATT&CK:T1078-003  
  <https://attack.mitre.org/techniques/T1078/003/>