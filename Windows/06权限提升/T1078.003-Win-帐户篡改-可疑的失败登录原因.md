# T1078.003-Win-可疑的失败登录行为

## 描述

攻击者可能通过凭据访问技术窃取特定用户或服务账号的凭据，或者在早期的侦察过程中通过社会工程手段捕获凭据以获得首次访问权限。

攻击者可能使用以下三类账号：
1. **默认账号**：操作系统内置的账号，例如Windows系统上的访客或管理员账号，或者其他类型系统、软件或设备上的默认工厂/提供商账号。
2. **本地账号**：由组织配置给用户、远程支持或服务的账号，或单个系统/服务的管理账号。
3. **域账号**：由活动目录域服务（AD-DS）管理的账号，其访问权限和权限在域内不同系统和服务之间配置，涵盖用户、管理员和服务账号。

攻击者可能利用窃取的凭据绕过网络内系统上各种资源的访问控制，甚至实现对远程系统和外部可用服务（如VPN、Outlook Web Access和远程桌面）的持久访问。此外，攻击者可能通过窃取的凭据获得特定系统的更高权限或访问网络受限区域。攻击者可能选择不将恶意软件或工具与这些凭据提供的合法访问结合使用，从而降低被检测的风险。

默认账号不仅限于客户端机器上的访客和管理员账号，还包括为设备（如网络设备和计算机应用）预设的账号。这些账号可能是内部的、开源的或商用现货产品（COTS）的。如果设备预设的用户名和密码组合在安装后未更改，将对组织构成严重威胁，因为它们容易成为攻击者的目标。同样，攻击者可能利用公开披露的私钥或盗取的私钥通过远程服务合法连接到远程环境。

需要特别关注跨系统网络的账号访问、凭据和权限的重叠，因为攻击者可能通过在不同账号和系统之间切换，获得更高的访问级别（如域管理员或企业管理员），从而绕过企业内设置的访问控制。

## 测试案例

**Windows账户登录失败**：模拟攻击者尝试使用禁用账号、受限账号或不被授权的账号进行登录，观察系统是否记录相关失败登录事件。

## 检测日志

**Windows 安全日志**：通过Windows事件查看器中的安全日志，捕获与登录失败相关的事件记录。

## 测试复现

场景较为简单，可通过以下步骤自行测试：
1. 使用已知被禁用或受限的账号尝试登录Windows系统。
2. 使用未授权的工作站或超出授权时间的账号进行登录尝试。
3. 观察Windows安全日志中生成的事件ID和状态码。

## 测试留痕

**Windows安全事件ID（适用于Windows 7 / Windows Server 2008及以上版本）**：
- **4625**：普通账户登录失败
- **4776**：域账户登录失败

## 检测规则/思路

### Sigma规则

```yml
title: 帐户篡改-可疑的失败登录原因
description: 此方法对失败的登录使用不常见的错误代码来确定可疑活动并篡改已禁用或受某种方式限制的帐户。
date: 2020/06/09
tags:
    - attack.persistence
    - attack.privilege_escalation
    - attack.t1078
logsource:
    product: windows
    service: security
detection:
    selection:
        EventID:
            - 4625 # 普通账户登录失败
            - 4776 # 域账户登录失败
        Status:
            - '0xC0000072'  # 用户登录到帐户已被管理员禁用
            - '0xC000006F'  # 用户在授权时间之外登录
            - '0xC0000070'  # 用户从未经授权的工作站登录
            - '0xC0000413'  # 登录失败：您登录的计算机受到身份验证防火墙的保护。指定的帐户不允许对计算机进行身份验证
            - '0xC000018C'  # 登录请求失败，因为主域和可信域之间的信任关系失败
            - '0xC000015B'  # 用户尚未在此计算机上被授予请求的登录类型（也称为登录权限）
    condition: selection
falsepositives:
    - 使用禁用帐户的用户
    - 合法用户在非授权时间或设备上尝试登录
level: high
```

**注意**：此规则主要针对用户账户登录失败行为的状态码进行分析，重点关注不常见的错误代码以识别潜在的账户篡改或未授权访问行为。

### 建议

1. **启用全面的日志记录**：确保Windows安全日志记录所有登录尝试，尤其是失败的登录事件，并定期审查这些日志。
2. **监控异常登录模式**：关注频繁的登录失败事件，特别是涉及禁用账号、受限账号或不常见错误代码的情况。
3. **加强默认账号管理**：更改所有默认账号的凭据，禁用不必要的默认账号，并定期审查默认账号的使用情况。
4. **实施最小权限原则**：限制账号的访问权限，确保用户和服务账号仅具有完成任务所需的最低权限。
5. **定期更新和审查信任关系**：检查域和可信域之间的信任关系，确保无异常配置。
6. **部署SIEM系统**：使用安全信息和事件管理（SIEM）系统，结合上述Sigma规则，实时监控和分析登录失败事件。

## 参考推荐

- MITRE ATT&CK: T1078.003  
  <https://attack.mitre.org/techniques/T1078/003>
- Microsoft Windows 安全事件日志  
  <https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625>  
  <https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4776>
- Sigma规则库  
  <https://github.com/SigmaHQ/sigma>