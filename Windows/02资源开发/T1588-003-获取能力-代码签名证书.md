# T1588-003-获取能力-代码签名证书

## 描述

在入侵目标组织之前，攻击者可能会购买、窃取或下载可在目标定位期间使用的代码签名证书。代码签名是对可执行文件和脚本进行数字签名的过程，以确认软件作者并确保代码未被更改或破坏。代码签名为开发者的程序提供一定的真实性，并保证程序未被篡改。相比未签名的代码，即使用户或安全工具不知道颁发证书的人或代码的作者，签名的代码也可能更容易获得信任。

攻击者可能通过购买或窃取代码签名证书来伪装合法软件，绕过安全检测或提升恶意代码的可信度。攻击者可以使用傀儡组织或利用从先前被入侵实体窃取的信息冒充合法实体，通过证书颁发机构（CA）完成代码签名证书的购买。此外，攻击者可能直接从被入侵的第三方窃取代码签名材料，或从暗网市场购买泄露的证书。

## 测试案例

暂无，仅提供辅助理解案例：

1. **窃取合法代码签名证书**  
   攻击者通过入侵软件公司或开发者的系统，窃取合法的代码签名证书，用于签署恶意软件以绕过安全软件检测。例如，某些恶意软件团伙利用泄露的证书签署恶意可执行文件，使其看似来自可信来源。  

2. **购买伪造证书**  
   攻击者通过暗网市场购买伪造的代码签名证书，或使用虚假身份从合法CA购买证书，进而签署恶意软件以伪装成合法应用程序。

## 检测日志

**无法有效监测**  
代码签名证书的获取通常发生在攻击者的环境中，与目标系统无直接交互，因此难以通过日志直接检测。可能相关的日志来源包括：

- **系统日志**：Windows事件日志（如事件ID 4657）可能记录证书安装或信任更改事件。
- **安全软件日志**：EDR或防病毒工具可能记录可疑签名或不受信任证书的执行尝试。
- **网络日志**：与证书验证相关的网络请求（如CRL或OCSP检查）可能提供间接线索。

## 测试复现

无具体复现方法。  
代码签名证书的获取通常在目标系统之外进行，难以在实验室环境中直接模拟。以下是一个概念性复现思路，仅供参考：

## 测试留痕

无明显留痕。  
代码签名证书的获取活动通常不会在目标系统上留下直接痕迹。相关留痕可能出现在后续阶段，包括：

- **证书安装**：如果攻击者将窃取或伪造的证书安装到目标系统的信任存储中，可能在证书管理器或系统日志中留下记录。
- **恶意软件执行**：签名后的恶意代码可能触发防病毒软件的警告或异常行为日志。
- **网络活动**：与证书验证相关的网络请求（如CRL或OCSP检查）可能被记录在网络流量日志中。

## 检测规则/思路

**检测规则**  
无明确的检测规则。由于证书的获取主要发生在攻击者的环境中，传统日志分析或入侵检测系统难以直接捕获。以下是一些可能的检测思路：

1. **监控异常证书行为**  
   - 检查系统中安装的代码签名证书，识别来源不明或可疑的证书。  
   - 使用工具（如Windows CertMgr或OpenSSL）分析证书链，检测非受信任根证书或异常颁发者。  

2. **行为分析**  
   - 监控可执行文件的签名状态，重点关注签名无效或使用可疑证书的文件。  
   - 使用EDR工具检测异常进程或文件的执行行为，尤其是与签名不匹配的情况。  

3. **网络流量分析**  
   - 检测与可疑证书相关的网络通信，如CRL或OCSP请求涉及未知颁发者。  
   - 监控异常的HTTPS流量，检查是否涉及伪造或不受信任的证书。  

4. **威胁情报整合**  
   - 使用威胁情报平台（如VirusTotal、ThreatConnect）检查已知被盗或伪造证书的指纹，关联潜在的攻击活动。

## 建议

### 缓解措施

由于代码签名证书的获取发生在企业防御和控制范围之外，难以通过预防性措施直接缓解。以下是一些建议：

1. **增强代码签名验证**  
   - 配置系统仅信任来自受信证书颁发机构（CA）的签名代码，限制伪造或不受信任证书的执行。  
   - 在操作系统或安全软件中配置策略，阻止未签名或签名无效的可执行文件运行。  
   - 示例Windows组策略设置：
     - 路径：`计算机配置->管理模板->系统->驱动程序安装`
     - 启用“代码签名用于设备驱动程序”并选择“阻止”。

2. **用户教育**  
   - 培训用户识别可疑软件，避免运行未知来源或提示证书不受信任的程序。  
   - 教授用户检查软件的数字签名（如右键单击文件->属性->数字签名）。

3. **应用程序白名单**  
   - 部署应用程序白名单策略，仅允许经过验证的合法应用程序运行，减少伪造签名恶意软件的影响。  
   - 示例工具：Windows AppLocker或第三方解决方案（如Carbon Black）。

4. **证书管理**  
   - 定期审计系统中的根证书和中间证书，移除或限制不受信任的证书。  
   - 使用证书透明度（CT）日志监控可疑证书的颁发。  

5. **系统加固**  
   - 限制用户安装不受信任证书的能力，防止攻击者将伪造证书添加到信任存储。  
   - 配置防火墙规则，限制与可疑证书相关的网络通信。

### 检测

由于此类活动通常在目标组织的可见性之外，检测工作应集中在相关后续行为上，包括但不限于：  
- **异常签名检测**：监控系统中运行的可执行文件，检查签名证书的合法性（如是否来自未知或伪造证书）。  
- **根证书安装监控**：检测系统中是否安装了非预期或不受信任的根证书，可能是攻击者为后续活动铺垫的迹象。  
  - 示例Windows事件ID：4657（注册表更改，可能涉及证书存储）。  
- **行为监控**：通过EDR或SIEM系统，关注异常的文件执行、进程行为或网络活动，尤其是与可疑签名证书相关的行为。  
- **威胁情报整合**：利用威胁情报平台（如VirusTotal、Recorded Future）检查已知被盗或伪造证书的指纹或哈希值。

## 参考推荐

- MITRE ATT&CK: T1588-003  
  <https://attack.mitre.org/techniques/T1588/003/>