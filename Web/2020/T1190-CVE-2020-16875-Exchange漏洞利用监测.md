# T1190-CVE-2020-16875-Exchange漏洞利用监测

## 来自ATTCK描述

使用软件，数据或命令来利用面向Internet的计算机系统或程序中的弱点，从而导致意外或无法预期的行为。系统的弱点可能是错误、故障或设计漏洞。这些应用程序通常是网站，但是可以包括数据库（例如SQL），标准服务（例如SMB 或SSH）以及具有Internet可访问开放的任何其他应用程序，例如Web服务器和相关服务。根据所利用的缺陷，这可能包括“利用防御防卫”。

如果应用程序托管在基于云的基础架构上，则对其进行利用可能会导致基础实际应用受到损害。这可以使攻击者获得访问云API或利用弱身份和访问管理策略的路径。

对于网站和数据库，OWASP排名前10位和CWE排名前25位突出了最常见的基于Web的漏洞。

## CVE-2020-16875

由于对cmdlet参数的验证不正确，Microsoft Exchange服务器中存在一个远程执行代码漏洞。成功利用此漏洞的攻击者可以在系统用户的上下文中运行任意代码。利用此漏洞需要拥有以某个Exchange角色进行身份验证的用户权限。

**利用条件：利用此漏洞需要拥有以某个Exchange角色进行身份验证的用户权限。** 因此在环境部署完成后需要新建一个用户“dahe”，同时也要为其开启DLP权限。

```bash
New-RoleGroup -Name "dlp users" -Roles "Data Loss Prevention" -Members "dahe"
Get-RoleGroup "dlp users" | Format-List
```

针对此漏洞的攻击将依次执行以下步骤：

- 在给定帐户下进行身份验证。
- 通过访问DLP策略管理功能获取参数。
- 添加新的恶意DLP策略，其中包含从PowerShell运行的可执行命令。

## 监测方法

使用IIS日志监测创建新DLP策略：

```yml
title: Creating a new DLP policy using IIS log monitoring
description: windows server 2016
author: DHZN
logsource:
​    product: windows
​    service: IIS
detection:
​    selection:
​        http_method: POST
        http_code: 200
        url_path|contain: '/ecp/DLPPolicy/ManagePolicyFromISV.aspx'
​    condition: selection
level: medium
```

想要利用该漏洞，必须创建一个新的策略，这个行为也会被记录在MSExchange管理日志中。在该事件的参数中包含恶意载荷：TemplateData。

使用Powershell日志/MSExchange管理日志监测创建新DLP策略：

```yml
title: Creating a new DLP policy using powrshell log or MSExchange Management Log monitoring
description: windows server 2016
author: DHZN
logsource:
​    product: windows
​    service: powershellaudit、MSExchange Management
detection:
​    selection:
​        EventID: 
              - 800
              - 1
              - 4014
        Message|contains|all: 
              - 'New-DlpPolicy'
              - '-TemplateData'
        
​    condition: selection
level: medium
```

使用Windows安全日志监测是否成功利用了CVE-2020-16875

```yml
title: Monitoring CVE-2020-16875 utilization behavior using Windows security logs
description: windows server 2016
author: DHZN
logsource:
​    product: windows
​    service: Security
detection:
​    selection:
​        EventID: 4688
        proc_parent_file_path|endswith: 'w3wp.exe'
        proc_file_path|contains|endswitch:
         - 'cmd.exe'
         - 'powershell.exe'  
​    condition: selection
level: high
```

在上述监测规则中，也可以调整子进程名称，对攻击者常见的进程名称进行监测，如whoami.exe等。

## 参考链接

[Exchange漏洞分析系列 CVE-2020-16875](https://www.anquanke.com/post/id/219091)

[CVE-2020-16875漏洞分析与复现](https://lhl7.github.io/2022/03/26/CVE-2020-16875%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%A4%8D%E7%8E%B0/)
