# T1590-004-收集目标组织网络信息-网络拓扑

## 来自ATT&CK的描述

攻击者在入侵目标组织之前，可能通过多种方式收集其网络拓扑信息。这些信息包括目标网络的物理或逻辑布局，例如内部和外部网络的结构、关键网络设备（如网关、路由器、交换机）的分布，以及其他基础设施的详细信息（如DMZ、子网划分）。通过了解网络拓扑，攻击者能够识别关键节点、潜在弱点或入口点，为后续的初始访问（如T1133外部远程服务）或横向移动（如T1021）奠定基础。

攻击者可能通过以下方式收集网络拓扑信息：
- **外部收集**：利用公开信息源（如搜索引擎、社交媒体、泄露的文档）或主动扫描外部网络接口。
- **内部收集**：在获得初始访问后，通过内网扫描、流量嗅探或配置信息提取获取更详细的拓扑信息。
- **社会工程**：通过钓鱼或社交媒体（如QQ群、论坛）获取员工泄露的网络架构信息。

## 测试案例

以下是常见的收集网络拓扑信息的常见方法和工具：
- **外部收集**：
  - **搜索引擎利用**：使用Google高级搜索语法（如`site:*.target.com filetype:pdf "network diagram"`）查找公开的网络架构文档。
  - **网盘检索**：搜索网盘（如百度网盘、Google Drive）中泄露的网络拓扑图或配置文件。
  - **社交媒体和论坛**：通过QQ群、微信群、Discord或技术论坛收集员工无意泄露的网络信息。
  - **被动DNS分析**：使用工具（如DNS Dumpster、SecurityTrails）分析DNS记录，推测子网或服务器分布。
- **内部收集**：
  - **网络扫描工具**：
    - **Nmap**：扫描内网IP范围，识别活跃主机、开放端口及服务。
    - **Angry IP Scanner**：快速扫描内网设备，获取IP和MAC地址。
  - **流量嗅探**：使用Wireshark或tcpdump捕获网络流量，分析通信模式以推导拓扑。
  - **配置提取**：通过已攻陷设备提取路由器或交换机的配置文件（如Cisco IOS的`show running-config`）。
- **空间搜索引擎**：
  - **FOFA/Shodan**：搜索目标组织的外部设备（如路由器、VPN网关）以推测网络边界。
  - **ZoomEye**：识别暴露的网络设备和服务。

## 检测日志

网络拓扑信息收集多发生在目标组织视野之外，检测难度较大。以下是可能用于检测的日志来源：
- **外部探测**：
  - **防火墙日志**：记录异常的外部扫描流量（如高频SYN包或端口扫描）。
  - **Web服务器日志**：检测异常的HTTP请求，可能与搜索引擎爬取或恶意探测相关。
  - **DNS日志**：监控针对组织域名的异常DNS查询。
- **内部活动**：
  - **网络流量日志**：检测内网中的异常扫描行为或流量模式。
  - **系统日志**：记录对网络设备（如路由器、交换机）的未授权访问尝试。
  - **EDR日志**：监控主机上的异常进程（如运行Nmap或Wireshark）。

## 测试复现

暂无标准化复现流程。可通过以下方式模拟：
- **外部测试**：使用FOFA或Shodan搜索目标组织的外部设备，结合Nmap进行端口扫描，记录暴露的网关或服务器。
- **内部测试**：在授权测试环境中，使用Nmap扫描内网IP范围，结合Wireshark捕获流量，绘制简单的网络拓扑图。
- **社会工程模拟**：在红队测试中，尝试通过公开信息源（如LinkedIn、论坛）或伪装身份获取员工泄露的网络信息。

## 测试留痕

- **外部探测**：可能在防火墙或IDS/IPS中留下扫描流量记录，如高频TCP/UDP连接尝试。
- **内部扫描**：内网设备可能记录异常的ARP请求、端口扫描或流量嗅探行为。
- **社会工程**：可能在邮件服务器或社交平台日志中留下钓鱼或信息收集的痕迹。
- **被动收集**：通过公开数据库或搜索引擎进行的收集通常不留明显痕迹。

## 检测规则/思路

由于网络拓扑收集活动难以直接检测，建议从以下角度进行监控：
- **外部扫描检测**：
  - 使用IDS/IPS（如Snort、Suricata）监控高频扫描流量或异常端口访问。
  - 设置防火墙规则，限制对敏感端口（如管理端口22、3389）的外部访问。
- **内部行为监控**：
  - 部署网络监控工具（如Zeek）分析内网流量，检测异常的扫描或嗅探行为。
  - 使用SIEM系统关联主机和网络日志，识别运行扫描工具的异常进程。
- **信息泄露防护**：
  - 监控公开信息源（如Pastebin、网盘）中是否出现组织的网络拓扑图或配置文件。
  - 使用DLP（数据丢失防护）工具检测员工通过邮件或社交媒体泄露敏感信息。
- **威胁情报整合**：结合外部威胁情报，识别已知的恶意IP或扫描模式，关联可能的侦察活动。

## 建议

- **减少信息暴露**：
  - 限制公开文档中的网络拓扑信息，避免在官网或网盘泄露架构图。
  - 对员工进行安全意识培训，防止通过社交媒体或论坛泄露敏感信息。
  - 使用CDN或WAF隐藏关键网络设备的真实IP地址。
- **网络安全加固**：
  - 限制外部对管理接口（如SSH、RDP）的访问，仅允许白名单IP。
  - 配置VLAN和网络分段，减少内网设备暴露面。
  - 定期更新网络设备的固件和访问控制列表（ACL）。
- **主动监控与响应**：
  - 部署网络流量分析工具（如Zeek、NetFlow）监控异常流量。
  - 使用威胁狩猎（Threat Hunting）技术，主动搜索可能的侦察行为。
  - 定期审计网络设备配置，检查是否被未授权访问。
- **后续阶段检测**：
  - 重点监控攻击者生命周期的后续阶段（如初始访问T1133、横向移动T1021），通过异常登录或网络流量间接发现侦察活动。

## 参考推荐

- MITRE ATT&CK: T1590-004  
  <https://attack.mitre.org/techniques/T1590/004/>
- 渗透测试信息收集技术  
  <https://blog.csdn.net/weixin_45677119/article/details/110870703>