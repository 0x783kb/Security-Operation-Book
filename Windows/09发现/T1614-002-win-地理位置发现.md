# T1614-002-win-地理位置发现

## 来自ATT&CK的描述

攻击者通过获取目标系统的地理或网络位置信息，为后续攻击（如定向钓鱼、物理渗透或网络路径劫持）提供关键情报。

## 测试案例

### windows

- 查询系统时区（如timedatectl命令或Windows注册表HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation）。
- 解析IP地址归属地（通过公开数据库如MaxMind GeoIP或REST API接口）。
- 检测系统语言设置（如systeminfo命令或浏览器语言首选项）。

## 检测日志

Windows 安全日志

## 测试复现

```bash
C:\Users\heihei>w32tm /tz
时区: 当前:TIME_ZONE_ID_UNKNOWN 偏量: -480分 (UTC=本地时间+Bias)
  [标准名称:"俄罗斯 TZ 7 标准时间" 偏量:0分 日期:(未指定)]
  [夏时制名称:"俄罗斯 TZ 7 夏令时" 偏量:-60分 日期:(未指定)]

C:\Users\heihei>reg query "HKLM\SYSTEM\CurrentControlSet\Control\TimeZoneInformation" /v StandardName

HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\TimeZoneInformation
    StandardName    REG_SZ    @tzres.dll,-1872


C:\Users\heihei>tzutil /g
North Asia East Standard Time
```

## 测试留痕

Windows安全日志可记录进程创建行为和命令行执行情况。

## 检测规则/思路

### sigma规则

```yml
title: 检测通过命令行工具查询系统时区的可疑行为 
id: a1b2c3d4-5678-90ef-ghij-klmnopqrstuv 
status: experimental 
description: 检测攻击者使用命令行工具（如tzutil.exe 、reg.exe 、w32tm.exe ）查询系统时区或注册表的行为，此类操作可能为攻击链中的地理位置发现阶段（ATT&CK T1614.002）。
references:
  - https://attack.mitre.org/techniques/T1614/002/ 
author: Your Name 
date: 2025/05/25 
tags:
  - attack.discovery  
  - attack.t1614.002 
logsource:
  product: windows 
  service: security 
  category: process_creation 
detection:
  selection:
    - ParentImage|endswith: '\cmd.exe' 
    - Image|endswith:
        - '\tzutil.exe' 
        - '\reg.exe' 
        - '\w32tm.exe' 
    - CommandLine|contains|all:
        - 'tzutil /g'          # 查询当前时区 
        - 'reg query "HKLM\\SYSTEM\\CurrentControlSet\\Control\\TimeZoneInformation"' # 查询注册表时区键 
        - 'w32tm /tz'          # 显示时区详情 
  condition: selection 
falsepositives:
  - 合法的系统管理任务（如管理员手动检查时区）
  - 自动化脚本或监控工具的正常调用 
level: medium 
```

### 建议

暂无

## 参考推荐

MITRE-ATT&CK-T1614

<https://attack.mitre.org/techniques/T1614/002/>

